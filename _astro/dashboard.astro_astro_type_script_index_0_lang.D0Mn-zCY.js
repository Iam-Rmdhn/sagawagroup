async function n(){const n=document.getElementById("mitra-table-body"),t=localStorage.getItem("adminToken");if(t){if(n)try{n.innerHTML='<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>';const e=await fetch("http://localhost:9999/api/admin/mitra",{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(!e.ok)throw new Error("Failed to fetch mitra data");const a=await e.json();if(a.success&&a.data){const t=a.data;if(0===t.length)return void(n.innerHTML='<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Tidak ada data mitra</td></tr>');let e="";t.forEach(n=>{const t="pending"===n.status?"bg-yellow-100 text-yellow-800":"approved"===n.status?"bg-green-100 text-green-800":"bg-red-100 text-red-800",a=`\n            <div class="flex flex-wrap gap-1">\n              <button onclick="showMitraDetail('${n._id}')" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition">\n                Detail\n              </button>\n              ${"pending"===n.status?`<button onclick="approveMitra('${n._id}', 'approve')" class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition">\n                   Approve\n                 </button>\n                 <button onclick="approveMitra('${n._id}', 'reject')" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition">\n                   Reject\n                 </button>`:`<span class="text-gray-500 text-xs">${"approved"===n.status?"Disetujui":"Ditolak"}</span>`}\n            </div>\n          `;e+=`\n            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">\n              <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">\n                ${n.namaMitra||"N/A"}\n              </th>\n              <td class="px-6 py-4">${n.email||"N/A"}</td>\n              <td class="px-6 py-4">${n.noHp||"N/A"}</td>\n              <td class="px-6 py-4">${n.paketUsaha||"N/A"}</td>\n              <td class="px-6 py-4">\n                <span class="px-2 py-1 text-xs font-medium rounded-full ${t}">\n                  ${n.status||"pending"}\n                </span>\n              </td>\n              <td class="px-6 py-4">\n                ${a}\n              </td>\n            </tr>\n          `}),n.innerHTML=e}else n.innerHTML='<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading data</td></tr>'}catch(e){const t=e instanceof Error?e.message:"Unknown error";n.innerHTML=`<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error: ${t}</td></tr>`}}else window.location.href="/admin/login"}function t(){const n=document.getElementById("imageModal");n&&n.classList.add("hidden")}document.addEventListener("DOMContentLoaded",function(){const t=localStorage.getItem("adminUser");if(t)try{const n=JSON.parse(t),e=document.getElementById("user-name"),a=document.getElementById("user-email"),i=document.getElementById("user-avatar");e&&(e.textContent=n.nama||"Admin User"),a&&(a.textContent=n.email||"admin@sagawa.com"),i&&(i.textContent=(n.nama||"Admin")[0].toUpperCase())}catch(d){}n();const e=document.getElementById("user-menu-button"),a=document.getElementById("dropdown-user");e&&a&&(e.addEventListener("click",function(n){n.stopPropagation(),a.classList.toggle("hidden")}),document.addEventListener("click",function(){a.classList.add("hidden")}));const i=document.getElementById("logout-btn");i&&i.addEventListener("click",function(n){n.preventDefault(),confirm("Apakah Anda yakin ingin logout?")&&(localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),window.location.href="/admin/login")});const o=document.getElementById("refresh-btn");o&&o.addEventListener("click",function(t){t.preventDefault(),n()});const r=document.querySelector('[data-drawer-toggle="logo-sidebar"]'),s=document.getElementById("logo-sidebar");r&&s&&r.addEventListener("click",function(){s.classList.toggle("-translate-x-full")})}),window.approveMitra=async function(t,e){const a=localStorage.getItem("adminToken");if(!a)return void(window.location.href="/admin/login");if(confirm(`Apakah Anda yakin ingin ${"approve"===e?"menyetujui":"menolak"} mitra ini?${"reject"===e?"\n\n⚠️ PERHATIAN: Data mitra yang ditolak akan DIHAPUS PERMANEN dari database!":""}`))try{const i=await fetch("http://localhost:9999/api/admin/mitra/approve",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({mitraId:t,action:e})}),o=await i.json();i.ok&&o.success?(alert(o.message),n()):alert(o.error||"Gagal memproses permintaan")}catch(i){const n=i instanceof Error?i.message:"Unknown error";alert(`Terjadi kesalahan saat memproses permintaan: ${n}`)}},document.addEventListener("click",function(n){const e=document.getElementById("imageModal"),a=document.getElementById("modalImage");e&&!e.classList.contains("hidden")&&n.target===e&&n.target!==a&&t()}),document.addEventListener("keydown",function(n){"Escape"===n.key&&t()}),window.showMitraDetail=async function(n){const t=localStorage.getItem("adminToken"),e=document.getElementById("mitraDetailModal"),a=document.getElementById("mitraDetailContent");if(t&&e&&a)try{e.classList.remove("hidden"),a.innerHTML='<div class="col-span-2 text-center">Loading...</div>';const i=await fetch(`http://localhost:9999/api/admin/mitra/${n}`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(!i.ok)throw new Error("Failed to fetch mitra detail");const o=await i.json();if(o.success&&o.data){!function(n){const t=document.getElementById("mitraDetailContent");if(!t)return;const e=n=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(n),a=n=>new Date(n).toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});t.innerHTML=`\n\n\n      \x3c!-- Informasi Dasar --\x3e\n      <div class="bg-gray-50 p-4 rounded-lg">\n        <h4 class="font-semibold text-gray-900 mb-3">Informasi Dasar</h4>\n        <div class="space-y-2">\n          <div><strong>Nama Mitra:</strong> ${n.namaMitra||"N/A"}</div>\n          <div><strong>Email:</strong> ${n.email||"N/A"}</div>\n          <div><strong>No HP:</strong> ${n.noHp||"N/A"}</div>\n          <div><strong>Alamat:</strong> ${n.alamatMitra||"N/A"}</div>\n          <div><strong>Status:</strong> \n            <span class="px-2 py-1 text-xs rounded-full ${"pending"===n.status?"bg-yellow-100 text-yellow-800":"approved"===n.status?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}">\n              ${n.status||"pending"}\n            </span>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Informasi Kemitraan --\x3e\n      <div class="bg-gray-50 p-4 rounded-lg">\n        <h4 class="font-semibold text-gray-900 mb-3">Informasi Kemitraan</h4>\n        <div class="space-y-2">\n          <div><strong>Sistem Kemitraan:</strong> ${n.sistemKemitraan||"N/A"}</div>\n          <div><strong>Sales:</strong> ${n.sales||"N/A"}</div>\n          <div><strong>Paket Usaha:</strong> ${n.paketUsaha||"N/A"}</div>\n          <div><strong>Lokasi Usaha:</strong> ${n.lokasi||"N/A"}</div>\n          <div><strong>Alamat Usaha:</strong> ${n.alamatUsaha||"N/A"}</div>\n        </div>\n      </div>\n\n      \x3c!-- Informasi Keuangan --\x3e\n      <div class="bg-gray-50 p-4 rounded-lg">\n        <h4 class="font-semibold text-gray-900 mb-3">Informasi Keuangan</h4>\n        <div class="space-y-2">\n          <div><strong>Nilai Paket:</strong> ${n.nilaiPaketUsaha||"N/A"}</div>\n          <div><strong>Harga Paket:</strong> ${n.hargaPaket?e(n.hargaPaket):"N/A"}</div>\n          <div><strong>Nominal DP:</strong> ${n.nominalDP?e(n.nominalDP):"N/A"}</div>\n          <div><strong>Nominal Full:</strong> ${n.nominalFull?e(n.nominalFull):"N/A"}</div>\n          <div><strong>Yang Harus Dibayar:</strong> ${n.yangHarusDibayar?e(n.yangHarusDibayar):"N/A"}</div>\n          <div><strong>Kekurangan:</strong> ${n.kekurangan?e(n.kekurangan):"N/A"}</div>\n        </div>\n      </div>\n\n      \x3c!-- Informasi Pembayaran --\x3e\n      <div class="bg-gray-50 p-4 rounded-lg">\n        <h4 class="font-semibold text-gray-900 mb-3">Informasi Pembayaran</h4>\n        <div class="space-y-2">\n          <div><strong>Metode Pembayaran:</strong> ${n.metodePembayaran||"N/A"}</div>\n          <div><strong>Bank:</strong> ${n.namaBank||"N/A"}</div>\n          <div><strong>No Rekening:</strong> ${n.nomorRekening||"N/A"}</div>\n          <div><strong>Nama Rekening:</strong> ${n.namaRekening||"N/A"}</div>\n          <div><strong>Bank Pengirim:</strong> ${n.bankPengirim||"N/A"}</div>\n          <div><strong>Nama Pengirim:</strong> ${n.namaPengirim||"N/A"}</div>\n        </div>\n      </div>\n\n      \x3c!-- File Dokumen --\x3e\n      <div class="bg-gray-50 p-4 rounded-lg col-span-2">\n        <h4 class="font-semibold text-gray-900 mb-4">Dokumen & Foto</h4>\n        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n          \x3c!-- Foto KTP --\x3e\n          \x3c!-- Foto KTP --\x3e\n          <div class="space-y-2">\n            <strong>Foto KTP:</strong>\n            ${n.fotoKTP&&""!==n.fotoKTP?`\n              <div class="mt-2">\n                <div class="border rounded-lg overflow-hidden bg-white shadow-sm">\n                  <img src="${n.fotoKTP}" \n                       alt="Foto KTP" \n                       class="w-full h-48 object-contain bg-gray-50 cursor-pointer hover:bg-gray-100 transition-all"\n                       onclick="openImageModal('${n.fotoKTP}', 'Foto KTP - ${n.namaMitra}')"\n                       onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">\n                  <div class="text-red-500 text-sm p-4 hidden text-center">\n                    <p>Gagal memuat gambar KTP</p>\n                  </div>\n                </div>\n                <p class="text-xs text-gray-500 mt-2 text-center">Klik untuk memperbesar</p>\n              </div>\n            `:'<span class="text-gray-500">Tidak ada foto KTP</span>'}\n          </div>\n          \n          \x3c!-- Bukti Transfer --\x3e\n          <div class="space-y-2">\n            <strong>Bukti Transfer:</strong>\n            ${n.buktiTransfer&&""!==n.buktiTransfer?`\n              <div class="mt-2">\n                <div class="border rounded-lg overflow-hidden bg-white shadow-sm">\n                  <img src="${n.buktiTransfer}" \n                       alt="Bukti Transfer" \n                       class="w-full h-48 object-contain bg-gray-50 cursor-pointer hover:bg-gray-100 transition-all"\n                       onclick="openImageModal('${n.buktiTransfer}', 'Bukti Transfer - ${n.namaMitra}')"\n                       onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">\n                  <div class="text-red-500 text-sm p-4 hidden text-center">\n                    <p>Gagal memuat bukti transfer</p>\n                  </div>\n                </div>\n                <p class="text-xs text-gray-500 mt-2 text-center">Klik untuk memperbesar</p>\n              </div>\n            `:'<span class="text-gray-500">Tidak ada bukti transfer</span>'}\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Informasi Waktu --\x3e\n      <div class="bg-gray-50 p-4 rounded-lg col-span-2">\n        <h4 class="font-semibold text-gray-900 mb-3">Informasi Waktu</h4>\n        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n          <div><strong>Dibuat:</strong> ${n.createdAt?a(n.createdAt):"N/A"}</div>\n          <div><strong>Diupdate:</strong> ${n.updatedAt?a(n.updatedAt):"N/A"}</div>\n        </div>\n      </div>\n    `}(o.data)}else a.innerHTML='<div class="col-span-2 text-center text-red-500">Error loading detail</div>'}catch(i){const n=i instanceof Error?i.message:"Unknown error";a.innerHTML=`<div class="col-span-2 text-center text-red-500">Error: ${n}</div>`}},window.closeMitraDetailModal=function(){const n=document.getElementById("mitraDetailModal");n&&n.classList.add("hidden")},window.openImageModal=function(n,t){const e=document.getElementById("imageModal"),a=document.getElementById("modalImage"),i=document.getElementById("modalImageTitle");if(e&&a&&i){e.classList.remove("hidden");let o="";o=n.startsWith("data:")?n:`data:image/png;base64,${n}`,a.src=o,a.alt=t,i.textContent=t,a.onerror=function(){i.textContent=t+" (Gagal memuat gambar)",a.style.display="none";const n=document.createElement("div");n.className="text-white text-center p-8",n.innerHTML='\n          <div class="text-red-500 bg-white p-4 rounded">\n            <p class="text-lg">⚠️ Gagal memuat gambar</p>\n            <p class="text-sm mt-2">Data gambar mungkin rusak</p>\n          </div>\n        ',a.parentElement?.appendChild(n)}}},window.closeImageModal=t;
