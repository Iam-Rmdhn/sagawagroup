const t="http://localhost:5000";function e(){const t=document.querySelector(".dashboard-stats"),e=document.querySelector(".user-stats");t&&e&&(t.classList.add("hidden"),e.classList.remove("hidden"))}function n(t,e=!1){const n=t.length,s=t.filter(t=>"pending"===t.status).length;t.filter(t=>"approved"===t.status).length;const r=t.filter(t=>"DP"===t.nilaiPaketUsaha).reduce((t,e)=>t+(e.yangHarusDibayar||0),0),o=t.filter(t=>"Full Payment"===t.nilaiPaketUsaha).reduce((t,e)=>t+(e.yangHarusDibayar||0),0);if(e){const t=document.getElementById("total-users-user"),e=document.getElementById("pending-user");t&&(t.textContent=n.toString()),e&&(e.textContent=s.toString())}else{const t=document.getElementById("total-users"),e=document.getElementById("dp-masuk"),i=document.getElementById("fp-masuk"),d=document.getElementById("pending-dashboard");t&&(t.textContent=n.toString()),e&&(e.textContent=a(r)),i&&(i.textContent=a(o)),d&&(d.textContent=s.toString())}}function a(t){return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(t)}function s(t){document.querySelectorAll("#users-dropdown button").forEach(t=>{t.classList.remove("bg-gray-100","text-gray-900","dark:bg-gray-700","dark:text-white"),t.classList.add("text-gray-900","dark:text-white")});const e=document.getElementById("dashboard-menu-btn");e&&e.classList.remove("active-menu"),t.classList.add("bg-gray-100","text-gray-900","dark:bg-gray-700","dark:text-white")}function r(){const t=document.getElementById("dashboard-menu-btn"),e=document.getElementById("show-all-users"),n=document.getElementById("show-approved-mitra"),a=document.getElementById("show-pending-mitra");if(t&&t.classList.contains("active-menu"))return"dashboard";const s=document.querySelector(".dashboard-stats");return document.querySelector(".user-stats"),s&&!s.classList.contains("hidden")?"dashboard":e&&e.classList.contains("bg-gray-100")?"all":n&&n.classList.contains("bg-gray-100")?"approved":a&&a.classList.contains("bg-gray-100")?"pending":"dashboard"}async function o(e="all"){const a=document.getElementById("mitra-table-body"),s=localStorage.getItem("adminToken");if(s){if(a)try{a.innerHTML='<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>';const r=await fetch(`${t}/api/admin/mitra`,{method:"GET",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}});if(!r.ok)throw new Error("Failed to fetch mitra data");const o=await r.json();if(o.success&&o.data){let t=o.data;"approved"===e?t=t.filter(t=>"approved"===t.status):"pending"===e&&(t=t.filter(t=>"pending"===t.status));const s=document.querySelector(".text-xl.font-semibold.text-gray-900.dark\\:text-white");if(s){let t="Mitra Management";"approved"===e?t="Mitra Sagawa (Disetujui)":"pending"===e?t="Menunggu Persetujuan":"all"===e?t="Semua User & Mitra":"dashboard"===e&&(t="Mitra Management"),s.textContent=t}if(0===t.length){let t="Tidak ada data mitra";"approved"===e?t="Tidak ada mitra yang disetujui":"pending"===e&&(t="Tidak ada mitra yang menunggu persetujuan"),a.innerHTML=`<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">${t}</td></tr>`;const s="dashboard"!==e;return void n(o.data,s)}let r="";t.forEach(t=>{const e="pending"===t.status?"bg-yellow-100 text-yellow-800":"approved"===t.status?"bg-green-100 text-green-800":"bg-red-100 text-red-800",n=`\n            <div class="flex flex-wrap gap-1">\n              <button onclick="showMitraDetail('${t._id}')" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition">\n                Detail\n              </button>\n              ${"pending"===t.status?`<button onclick="approveMitra('${t._id}', 'approve')" class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition">\n                   Approve\n                 </button>\n                 <button onclick="approveMitra('${t._id}', 'reject')" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition">\n                   Reject\n                 </button>`:`<span class="text-gray-500 text-xs">${"approved"===t.status?"Disetujui":"Ditolak"}</span>`}\n            </div>\n          `;r+=`\n            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">\n              <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">\n                ${t.namaMitra||"N/A"}\n              </th>\n              <td class="px-6 py-4">${t.email||"N/A"}</td>\n              <td class="px-6 py-4">${t.noHp||"N/A"}</td>\n              <td class="px-6 py-4">${t.paketUsaha||"N/A"}</td>\n              <td class="px-6 py-4">\n                <span class="px-2 py-1 text-xs font-medium rounded-full ${e}">\n                  ${t.status||"pending"}\n                </span>\n              </td>\n              <td class="px-6 py-4">\n                ${n}\n              </td>\n            </tr>\n          `}),a.innerHTML=r;const i="dashboard"!==e;n(o.data,i)}else a.innerHTML='<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading data</td></tr>'}catch(r){const t=r instanceof Error?r.message:"Unknown error";a.innerHTML=`<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error: ${t}</td></tr>`}}else window.location.href="/admin/login"}function i(){const t=document.getElementById("imageModal");t&&t.classList.add("hidden")}document.addEventListener("DOMContentLoaded",function(){const t=localStorage.getItem("adminUser");if(t)try{const e=JSON.parse(t),n=document.getElementById("user-name"),a=document.getElementById("user-email"),s=document.getElementById("user-avatar");n&&(n.textContent=e.nama||"Admin User"),a&&(a.textContent=e.email||"admin@sagawa.com"),s&&(s.textContent=(e.nama||"Admin")[0].toUpperCase())}catch(h){}o("dashboard");const n=document.getElementById("users-dropdown-button"),a=document.getElementById("users-dropdown");n&&a&&n.addEventListener("click",function(t){t.preventDefault(),a.classList.toggle("hidden");const e=document.getElementById("dashboard-menu-btn");e&&!a.classList.contains("hidden")&&e.classList.remove("active-menu")});const i=document.getElementById("show-all-users"),d=document.getElementById("show-approved-mitra"),l=document.getElementById("show-pending-mitra");i&&i.addEventListener("click",function(t){t.preventDefault(),e(),o("all"),s(i)}),d&&d.addEventListener("click",function(t){t.preventDefault(),e(),o("approved"),s(d)}),l&&l.addEventListener("click",function(t){t.preventDefault(),e(),o("pending"),s(l)});const c=document.getElementById("dashboard-menu-btn");c&&c.addEventListener("click",function(t){t.preventDefault(),function(){const t=document.querySelector(".dashboard-stats"),e=document.querySelector(".user-stats"),n=document.getElementById("users-dropdown");t&&e&&(e.classList.add("hidden"),t.classList.remove("hidden"));n&&n.classList.add("hidden")}(),o("dashboard"),function(t){const e=document.getElementById("dashboard-menu-btn");e&&e.classList.remove("active-menu");document.querySelectorAll("#users-dropdown button").forEach(t=>{t.classList.remove("bg-gray-100","text-gray-900","dark:bg-gray-700","dark:text-white")}),t.classList.add("active-menu")}(c)});const m=document.getElementById("user-menu-button"),g=document.getElementById("dropdown-user");m&&g&&(m.addEventListener("click",function(t){t.stopPropagation(),g.classList.toggle("hidden")}),document.addEventListener("click",function(){g.classList.add("hidden")}));const u=document.getElementById("logout-btn");u&&u.addEventListener("click",function(t){t.preventDefault(),confirm("Apakah Anda yakin ingin logout?")&&(localStorage.removeItem("adminToken"),localStorage.removeItem("adminUser"),window.location.href="/admin/login")});const p=document.getElementById("refresh-btn");p&&p.addEventListener("click",function(t){t.preventDefault();o(r())});const y=document.querySelector('[data-drawer-toggle="logo-sidebar"]'),v=document.getElementById("logo-sidebar");y&&v&&y.addEventListener("click",function(){v.classList.toggle("-translate-x-full")})}),window.approveMitra=async function(e,n){const a=localStorage.getItem("adminToken");if(!a)return void(window.location.href="/admin/login");if(confirm(`Apakah Anda yakin ingin ${"approve"===n?"menyetujui":"menolak"} mitra ini?${"reject"===n?"\n\n⚠️ PERHATIAN: Data mitra yang ditolak akan DIHAPUS PERMANEN dari database!":""}`))try{const s=await fetch(`${t}/api/admin/mitra/approve`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({mitraId:e,action:n})}),i=await s.json();if(s.ok&&i.success){alert(i.message);o(r())}else alert(i.error||"Gagal memproses permintaan")}catch(s){const t=s instanceof Error?s.message:"Unknown error";alert(`Terjadi kesalahan saat memproses permintaan: ${t}`)}},document.addEventListener("click",function(t){const e=document.getElementById("imageModal"),n=document.getElementById("modalImage");e&&!e.classList.contains("hidden")&&t.target===e&&t.target!==n&&i()}),document.addEventListener("keydown",function(t){"Escape"===t.key&&i()}),window.showMitraDetail=async function(e){const n=localStorage.getItem("adminToken"),a=document.getElementById("mitraDetailModal"),s=document.getElementById("mitraDetailContent");if(n&&a&&s)try{a.classList.remove("hidden"),s.innerHTML='<div class="col-span-2 text-center">Loading...</div>';const r=await fetch(`${t}/api/admin/mitra/${e}`,{method:"GET",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"}});if(!r.ok)throw new Error("Failed to fetch mitra detail");const o=await r.json();if(o.success&&o.data){!function(t){const e=document.getElementById("mitraDetailContent");if(!e)return;const n=t=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(t),a=t=>new Date(t).toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});e.innerHTML=`\n\n\n      \x3c!-- Informasi Data Pribadi --\x3e\n      <div class="bg-gray-50 p-4 rounded-lg">\n        <h4 class="font-semibold text-gray-900 mb-3">Informasi Data Pribadi</h4>\n        <div class="space-y-2">\n          <div><strong>Nama Mitra:</strong> ${t.namaMitra||"N/A"}</div>\n          <div><strong>Email:</strong> ${t.email||"N/A"}</div>\n          <div><strong>No HP:</strong> ${t.noHp||"N/A"}</div>\n          <div><strong>Alamat:</strong> ${t.alamatMitra||"N/A"}</div>\n          <div><strong>Status:</strong> \n            <span class="px-2 py-1 text-xs rounded-full ${"pending"===t.status?"bg-yellow-100 text-yellow-800":"approved"===t.status?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}">\n              ${t.status||"pending"}\n            </span>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Informasi Kemitraan --\x3e\n      <div class="bg-gray-50 p-4 rounded-lg">\n        <h4 class="font-semibold text-gray-900 mb-3">Informasi Kemitraan</h4>\n        <div class="space-y-2">\n          <div><strong>Sistem Kemitraan:</strong> ${t.sistemKemitraan||"N/A"}</div>\n          <div><strong>Sales:</strong> ${t.sales||"N/A"}</div>\n          <div><strong>Paket Usaha:</strong> ${t.paketUsaha||"N/A"}</div>\n        </div>\n      </div>\n\n      \x3c!-- Informasi Keuangan --\x3e\n      <div class="bg-gray-50 p-4 rounded-lg">\n        <h4 class="font-semibold text-gray-900 mb-3">Informasi Keuangan</h4>\n        <div class="space-y-2">\n          <div><strong>Nilai Paket:</strong> ${t.nilaiPaketUsaha||"N/A"}</div>\n          <div><strong>Harga Paket:</strong> ${t.hargaPaket?n(t.hargaPaket):"N/A"}</div>\n          <div><strong>Nominal DP:</strong> ${t.nominalDP?n(t.nominalDP):"N/A"}</div>\n          <div><strong>Nominal Full:</strong> ${t.nominalFull?n(t.nominalFull):"N/A"}</div>\n          <div><strong>Yang Harus Dibayar:</strong> ${t.yangHarusDibayar?n(t.yangHarusDibayar):"N/A"}</div>\n          <div><strong>Kekurangan:</strong> ${t.kekurangan?n(t.kekurangan):"N/A"}</div>\n        </div>\n      </div>\n\n      \x3c!-- Informasi Pembayaran --\x3e\n      <div class="bg-gray-50 p-4 rounded-lg">\n        <h4 class="font-semibold text-gray-900 mb-3">Informasi Pembayaran</h4>\n        <div class="space-y-2">\n          <div><strong>Metode Pembayaran:</strong> Transfer</div>\n          <div><strong>Bank Pengirim:</strong> ${t.bankPengirim||"N/A"}</div>\n          <div><strong>No Rekening:</strong> ${t.noRekPengirim||"N/A"}</div>\n          <div><strong>Nama Pengirim:</strong> ${t.namaPengirim||"N/A"}</div>\n        </div>\n      </div>\n\n      \x3c!-- File Dokumen --\x3e\n      <div class="bg-gray-50 p-4 rounded-lg col-span-2">\n        <h4 class="font-semibold text-gray-900 mb-4">Dokumen & Foto</h4>\n        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n          \x3c!-- Foto KTP --\x3e\n          <div class="space-y-2">\n            <strong>Foto KTP, NPWP & Foto Mitra:</strong>\n            ${t.fotoKTP&&""!==t.fotoKTP?`\n              <div class="mt-2">\n                <div class="border rounded-lg overflow-hidden bg-white shadow-sm">\n                  <img src="${t.fotoKTP}" \n                       alt="Foto KTP" \n                       class="w-full h-48 object-contain bg-gray-50 cursor-pointer hover:bg-gray-100 transition-all"\n                       onclick="openImageModal('${t.fotoKTP}', 'Foto KTP - ${t.namaMitra}')"\n                       onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">\n                  <div class="text-red-500 text-sm p-4 hidden text-center">\n                    <p>Gagal memuat gambar KTP</p>\n                  </div>\n                </div>\n                <p class="text-xs text-gray-500 mt-2 text-center">Klik untuk memperbesar</p>\n              </div>\n            `:'<span class="text-gray-500">Tidak ada foto KTP</span>'}\n          </div>\n          \n          \x3c!-- Bukti Transfer --\x3e\n          <div class="space-y-2">\n            <strong>Bukti Transfer:</strong>\n            ${t.buktiTransfer&&""!==t.buktiTransfer?`\n              <div class="mt-2">\n                <div class="border rounded-lg overflow-hidden bg-white shadow-sm">\n                  <img src="${t.buktiTransfer}" \n                       alt="Bukti Transfer" \n                       class="w-full h-48 object-contain bg-gray-50 cursor-pointer hover:bg-gray-100 transition-all"\n                       onclick="openImageModal('${t.buktiTransfer}', 'Bukti Transfer - ${t.namaMitra}')"\n                       onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">\n                  <div class="text-red-500 text-sm p-4 hidden text-center">\n                    <p>Gagal memuat bukti transfer</p>\n                  </div>\n                </div>\n                <p class="text-xs text-gray-500 mt-2 text-center">Klik untuk memperbesar</p>\n              </div>\n            `:'<span class="text-gray-500">Tidak ada bukti transfer</span>'}\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Informasi Waktu --\x3e\n      <div class="bg-gray-50 p-4 rounded-lg col-span-2">\n        <h4 class="font-semibold text-gray-900 mb-3">Informasi Waktu</h4>\n        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n          <div><strong>Dibuat:</strong> ${t.createdAt?a(t.createdAt):"N/A"}</div>\n          <div><strong>Diupdate:</strong> ${t.updatedAt?a(t.updatedAt):"N/A"}</div>\n        </div>\n      </div>\n    `}(o.data)}else s.innerHTML='<div class="col-span-2 text-center text-red-500">Error loading detail</div>'}catch(r){const t=r instanceof Error?r.message:"Unknown error";s.innerHTML=`<div class="col-span-2 text-center text-red-500">Error: ${t}</div>`}},window.closeMitraDetailModal=function(){const t=document.getElementById("mitraDetailModal");t&&t.classList.add("hidden")},window.openImageModal=function(t,e){const n=document.getElementById("imageModal"),a=document.getElementById("modalImage"),s=document.getElementById("modalImageTitle");if(n&&a&&s){n.classList.remove("hidden");let r="";r=t.startsWith("data:")?t:`${t}`,a.src=r,a.alt=e,s.textContent=e,a.onerror=function(){s.textContent=e+" (Gagal memuat gambar)",a.style.display="none";const t=document.createElement("div");t.className="text-white text-center p-8",t.innerHTML='\n          <div class="text-red-500 bg-white p-4 rounded">\n            <p class="text-lg">Gagal memuat gambar</p>\n            <p class="text-sm mt-2">Data gambar mungkin rusak</p>\n          </div>\n        ',a.parentElement?.appendChild(t)}}},window.closeImageModal=i;
