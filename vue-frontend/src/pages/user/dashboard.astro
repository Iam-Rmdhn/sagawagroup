---
import Layout from '../../layouts/Layout.astro';
import MitraSidebar from '../../components/mitra/sidebar/MitraSidebar.astro';
import MitraNavbar from '../../components/mitra/navbar/MitraNavbar.astro';
// User Dashboard

// Fetch data omset/belanja dari backend (SSR)
let omsetHariIni = [];
let omsetBulanIni = 0;
let belanjaHariIni = [];
try {
   const res = await fetch("http://localhost:3000/api/sheets/omset");
   if (res.ok) {
      const data = await res.json();
      omsetHariIni = data.omsetHariIni || [];
      omsetBulanIni = data.omsetBulanIni || 0;
      belanjaHariIni = data.belanjaHariIni || [];
   }
} catch (e) {}
---

<Layout title="Dashboard Mitra">
  <!-- Modern Dashboard Styles -->
  <style>
    /* Global fixes for scroll stability */
    * {
      transform: translateZ(0);
      will-change: auto;
    }
    
    *,
    *::before,
    *::after {
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      -webkit-perspective: 1000px;
      perspective: 1000px;
    }
    
    body, html {
      overflow-x: hidden;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      background-color: #fefefe;
    }
    
    /* Custom Amber Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(251, 191, 36, 0.1);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, rgb(245 158 11), rgb(251 191 36));
      border-radius: 4px;
    }
    
    /* Firefox scrollbar styling */
    * {
      scrollbar-width: thin;
      scrollbar-color: rgb(245 158 11) rgba(251, 191, 36, 0.1);
    }

    /* Modern card styling */
    .modern-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(251, 191, 36, 0.02) 100%);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(251, 191, 36, 0.1);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      transform: translate3d(0, 0, 0);
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      position: relative;
    }

    /* Status badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .status-badge.active {
      background: linear-gradient(135deg, rgb(34 197 94), rgb(22 163 74));
      color: white;
    }

    .status-badge.pending {
      background: linear-gradient(135deg, rgb(245 158 11), rgb(251 191 36));
      color: white;
    }

    .status-badge.rejected {
      background: linear-gradient(135deg, rgb(239 68 68), rgb(220 38 38));
      color: white;
    }

    /* Loading animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .loading-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* Welcome message fade in */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #profile-name, #welcome-message, #greeting-time {
      animation: fadeInUp 0.6s ease-out;
    }

    #profile-email {
      animation: fadeInUp 0.8s ease-out;
    }

    #profile-status, #join-badge {
      animation: fadeInUp 1s ease-out;
    }

    /* Background pattern */
    .dashboard-bg {
      background-image: 
        radial-gradient(circle at 25px 25px, rgba(251, 191, 36, 0.03) 2px, transparent 0),
        radial-gradient(circle at 75px 75px, rgba(249, 115, 22, 0.03) 2px, transparent 0);
      background-size: 100px 100px;
      background-position: 0 0, 50px 50px;
      background-attachment: fixed;
      min-height: 100vh;
      background-color: #fefefe;
    }

    /* Ensure logout button is always clickable */
    #logout-btn {
      pointer-events: auto !important;
      cursor: pointer !important;
    }
    
    #logout-btn:disabled {
      pointer-events: auto !important;
      cursor: pointer !important;
      opacity: 1 !important;
    }

    /* Responsive grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    /* Investment box in header styling */
    .investment-box-header {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Info item styling - Simple & Clean */
    .info-item {
      position: relative;
      padding: 0.75rem;
      border-radius: 0.5rem;
   }

    /* Activity timeline animations */
    .activity-item-enter {
      animation: slideInLeft 0.3s ease-out;
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Icon containers - Simplified */
    .icon-container {
      background: linear-gradient(135deg, rgb(245 158 11), rgb(249 115 22));
      transform: translate3d(0, 0, 0);
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
    }

    .icon-container.success {
      background: linear-gradient(135deg, rgb(34 197 94), rgb(22 163 74));
    }

    .icon-container.warning {
      background: linear-gradient(135deg, rgb(245 158 11), rgb(251 191 36));
    }

    .icon-container.danger {
      background: linear-gradient(135deg, rgb(239 68 68), rgb(220 38 38));
    }

    .icon-container.info {
      background: linear-gradient(135deg, rgb(59 130 246), rgb(37 99 235));
    }

    @media (max-width: 640px) {
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .modern-card {
        padding: 1rem;
      }

      /* Mobile specific adjustments */
      .dashboard-bg {
        padding: 0.75rem;
      }

      /* Reduce font sizes on mobile */
      .stats-number {
        font-size: 1.75rem !important;
      }

      /* Better spacing on mobile */
      .mb-8 {
        margin-bottom: 1.5rem;
      }

      .mb-6 {
        margin-bottom: 1rem;
      }

      /* Mobile header adjustments */
      .text-4xl {
        font-size: 2rem !important;
      }

      .text-3xl {
        font-size: 1.5rem !important;
      }

      .text-2xl {
        font-size: 1.25rem !important;
      }

      .text-xl {
        font-size: 1rem !important;
      }

      /* Icon container adjustments */
      .icon-container {
        width: 2.5rem !important;
        height: 2.5rem !important;
      }

      .icon-container svg {
        width: 1rem !important;
        height: 1rem !important;
      }

      /* Padding adjustments */
      .p-6 {
        padding: 1rem !important;
      }

      .p-8 {
        padding: 1.25rem !important;
      }
    }

    @media (max-width: 480px) {
      /* Extra small mobile devices */
      .stats-grid {
        gap: 0.75rem;
      }

      .modern-card {
        padding: 0.75rem;
      }

      .stats-number {
        font-size: 1.5rem !important;
      }

      .text-lg {
        font-size: 0.875rem !important;
      }

      /* Very compact spacing */
      .mb-8 {
        margin-bottom: 1rem;
      }

      .mb-6 {
        margin-bottom: 0.75rem;
      }

      .space-y-4 > * + * {
        margin-top: 0.75rem !important;
      }

      /* Financial cards in single column on very small screens */
      .financial-section .stats-grid {
        grid-template-columns: 1fr !important;
        gap: 0.5rem;
      }

      /* Detail grid adjustments */
      .grid.lg\\:grid-cols-2 {
        grid-template-columns: 1fr !important;
      }

      /* Button size adjustments */
      button, .btn {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.75rem !important;
      }

      /* Truncate long text */
      .truncate-mobile {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    }

    @media (min-width: 768px) and (max-width: 1024px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Disable text selection and copying for agreement content */
    .agreement-content {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
      user-drag: none;
      cursor: default;
    }
    
    .agreement-content * {
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      user-select: none !important;
      -webkit-touch-callout: none !important;
      pointer-events: none;
    }
    
    /* Allow interaction with form elements inside agreement */
    .agreement-content input,
    .agreement-content button,
    .agreement-content textarea,
    .agreement-content select {
      pointer-events: auto;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    /* Hide scrollbar on mobile for agreement modal */
    @media (max-width: 768px) {
      #agreement-modal {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
      }
      
      #agreement-modal::-webkit-scrollbar {
        display: none;  /* Chrome, Safari and Opera */
      }

      /* Hide scrollbar in agreement content area on mobile */
      #agreement-modal .overflow-y-auto {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      #agreement-modal .overflow-y-auto::-webkit-scrollbar {
        display: none;
      }
    }

    /* Skeleton Loading Animations */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s ease-in-out infinite;
    }

    @keyframes loading {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    .skeleton-text {
      height: 1rem;
      border-radius: 0.25rem;
    }

    .skeleton-title {
      height: 2rem;
      border-radius: 0.5rem;
    }

    .skeleton-avatar {
      border-radius: 9999px;
    }

    .skeleton-card {
      border-radius: 1rem;
    }
  </style>

<MitraNavbar />
<MitraSidebar currentPage="dashboard" />

<div id="main-dashboard" class="dashboard-bg p-2 sm:p-4">
   <div class="p-2 sm:p-6 mt-16">
      
      <!-- Loading State - Skeleton -->
      <div id="loading-state" class="space-y-6">
         <!-- Header Skeleton -->
         <div class="modern-card rounded-xl p-6 shadow-xl">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
               <div class="flex-1 space-y-4">
                  <div class="flex items-center gap-3">
                     <div class="skeleton skeleton-avatar w-10 h-10"></div>
                     <div class="flex-1 space-y-2">
                        <div class="skeleton skeleton-text w-32"></div>
                        <div class="skeleton skeleton-title w-48"></div>
                     </div>
                  </div>
                  <div class="skeleton skeleton-text w-full max-w-md"></div>
                  <div class="skeleton skeleton-text w-64"></div>
                  <div class="flex gap-2">
                     <div class="skeleton w-24 h-6 rounded-full"></div>
                     <div class="skeleton w-32 h-6 rounded-full"></div>
                  </div>
               </div>
               <div class="hidden lg:block">
                  <div class="skeleton skeleton-card w-64 h-32"></div>
               </div>
            </div>
         </div>

         <!-- Mobile Investment Card Skeleton -->
         <div class="lg:hidden modern-card rounded-xl p-6 shadow-xl">
            <div class="space-y-3">
               <div class="skeleton skeleton-text w-32 mx-auto"></div>
               <div class="skeleton skeleton-title w-48 mx-auto"></div>
               <div class="skeleton skeleton-text w-40 mx-auto"></div>
            </div>
         </div>

         <!-- Financial Cards Skeleton -->
         <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="modern-card rounded-xl p-6 shadow-lg">
               <div class="space-y-4">
                  <div class="flex items-center justify-between">
                     <div class="skeleton skeleton-text w-32"></div>
                     <div class="skeleton skeleton-avatar w-10 h-10"></div>
                  </div>
                  <div class="skeleton skeleton-title w-40"></div>
                  <div class="skeleton skeleton-text w-24"></div>
               </div>
            </div>
            <div class="modern-card rounded-xl p-6 shadow-lg">
               <div class="space-y-4">
                  <div class="flex items-center justify-between">
                     <div class="skeleton skeleton-text w-32"></div>
                     <div class="skeleton skeleton-avatar w-10 h-10"></div>
                  </div>
                  <div class="skeleton skeleton-title w-40"></div>
                  <div class="skeleton skeleton-text w-24"></div>
               </div>
            </div>
            <div class="modern-card rounded-xl p-6 shadow-lg">
               <div class="space-y-4">
                  <div class="flex items-center justify-between">
                     <div class="skeleton skeleton-text w-32"></div>
                     <div class="skeleton skeleton-avatar w-10 h-10"></div>
                  </div>
                  <div class="skeleton skeleton-title w-40"></div>
                  <div class="skeleton skeleton-text w-24"></div>
               </div>
            </div>
         </div>

         <!-- Profile Card Skeleton -->
         <div class="modern-card rounded-xl p-6 shadow-lg">
            <div class="space-y-6">
               <div class="flex items-center gap-3 pb-4 border-b-2 border-gray-200">
                  <div class="skeleton skeleton-avatar w-10 h-10"></div>
                  <div class="space-y-2 flex-1">
                     <div class="skeleton skeleton-text w-48"></div>
                     <div class="skeleton skeleton-text w-32"></div>
                  </div>
               </div>
               <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div class="space-y-2">
                     <div class="skeleton skeleton-text w-24"></div>
                     <div class="skeleton skeleton-text w-32"></div>
                  </div>
                  <div class="space-y-2">
                     <div class="skeleton skeleton-text w-24"></div>
                     <div class="skeleton skeleton-text w-40"></div>
                  </div>
                  <div class="space-y-2">
                     <div class="skeleton skeleton-text w-24"></div>
                     <div class="skeleton skeleton-text w-32"></div>
                  </div>
                  <div class="space-y-2 md:col-span-2 lg:col-span-3">
                     <div class="skeleton skeleton-text w-24"></div>
                     <div class="skeleton skeleton-text w-full"></div>
                  </div>
               </div>
               <div class="border-t border-gray-200 pt-6">
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                     <div class="space-y-2">
                        <div class="skeleton skeleton-text w-20"></div>
                        <div class="skeleton skeleton-text w-28"></div>
                     </div>
                     <div class="space-y-2">
                        <div class="skeleton skeleton-text w-20"></div>
                        <div class="skeleton skeleton-text w-32"></div>
                     </div>
                     <div class="space-y-2">
                        <div class="skeleton skeleton-text w-20"></div>
                        <div class="skeleton w-24 h-6 rounded-full"></div>
                     </div>
                     <div class="space-y-2">
                        <div class="skeleton skeleton-text w-20"></div>
                        <div class="skeleton skeleton-text w-32"></div>
                     </div>
                  </div>
               </div>
            </div>
         </div>

         <!-- Activity Card Skeleton -->
         <div class="modern-card rounded-xl p-6 shadow-lg">
            <div class="space-y-6">
               <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                     <div class="skeleton skeleton-avatar w-10 h-10"></div>
                     <div class="space-y-2">
                        <div class="skeleton skeleton-text w-32"></div>
                        <div class="skeleton skeleton-text w-24"></div>
                     </div>
                  </div>
                  <div class="skeleton w-16 h-6 rounded-full"></div>
               </div>
               <div class="space-y-3">
                  <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                     <div class="skeleton skeleton-avatar w-8 h-8"></div>
                     <div class="flex-1 space-y-2">
                        <div class="skeleton skeleton-text w-24"></div>
                        <div class="skeleton skeleton-text w-32"></div>
                     </div>
                  </div>
                  <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                     <div class="skeleton skeleton-avatar w-8 h-8"></div>
                     <div class="flex-1 space-y-2">
                        <div class="skeleton skeleton-text w-24"></div>
                        <div class="skeleton skeleton-text w-40"></div>
                     </div>
                  </div>
                  <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                     <div class="skeleton skeleton-avatar w-8 h-8"></div>
                     <div class="flex-1 space-y-2">
                        <div class="skeleton skeleton-text w-24"></div>
                        <div class="skeleton skeleton-text w-20"></div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>

      <!-- Main Dashboard Content -->
      <div id="dashboard-content" class="hidden">
         
         <!-- Welcome Header -->
         <div class="mb-6 pt-2 sm:mb-8">
            <div class="bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl p-6 text-white shadow-xl">
               <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                  <div class="flex-1">
                     <div class="flex items-center gap-2 mb-3">
                        <svg class="w-10 h-10 ml-1 mr-2 text-white opacity-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path>
                        </svg>
                        <div>
                           <p class="text-sm opacity-90 font-medium" id="greeting-time">Selamat Datang</p>
                           <h1 class="text-3xl font-bold" id="profile-name">Mitra Sagawa Group</h1>
                        </div>
                     </div>
                     <p class="opacity-90 text-base mb-2" id="welcome-message">Terima kasih telah bergabung dengan keluarga besar Sagawa Group</p>
                     <p class="opacity-80 text-sm mb-3" id="profile-email">Memuat data...</p>
                     <div class="flex flex-wrap items-center gap-2">
                        <span id="profile-status" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-600 bg-opacity-90 text-white">
                           Status: Memuat...
                        </span>
                        <span id="join-badge" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-600 bg-opacity-90 text-white" style="display: none;">
                           <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                           </svg>
                           Member sejak<span id="join-date-text">-</span>
                        </span>
                     </div>
                  </div>
                  <!-- Nilai Investment - Desktop -->
                  <div class="hidden lg:block bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-6 min-w-[280px]">
                     <div class="text-center">
                        <p class="text-sm font-medium opacity-90 mb-1">Nilai Investment</p>
                        <p class="text-3xl font-bold" id="nilai-paket-header">
                           <span class="loading-pulse">Memuat...</span>
                        </p>
                        <p class="text-xs opacity-75 mt-1">Total investasi paket</p>
                     </div>
                  </div>
               </div>
            </div>
         </div>

         <!-- Nilai Paket Card - Mobile Only -->
         <div class="mb-6 sm:mb-8 lg:hidden">
            <div class="modern-card rounded-xl sm:rounded-2xl p-6 sm:p-8 shadow-xl">
               <div class="text-center">
                  <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-2">Nilai Investment</h3>
                  <p class="stats-number text-2xl sm:text-4xl font-bold text-amber-600 mb-2" id="nilai-paket">
                     <span class="loading-pulse">Memuat...</span>
                  </p>
                  <p class="text-sm sm:text-base text-gray-600">Total investasi paket kemitraan Anda</p>
               </div>
            </div>
         </div>

            <!-- Financial Summary Cards -->
            <div id="financial-summary-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
               <!-- Omset Harian -->
               <div class="modern-card rounded-2xl p-6 shadow-lg overflow-hidden relative">
                  <div class="absolute top-0 right-0 w-24 h-24 -mr-8 -mt-8 bg-gradient-to-br from-amber-300/20 to-orange-400/20 rounded-full"></div>
                  <div class="relative z-10">
                     <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Omset Hari Ini</h3>
                        <div class="w-10 h-10 flex items-center justify-center">
                           <svg class="w-10 h-10 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 0 0-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 0 1-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 0 0 3 15h-.75M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm3 0h.008v.008H18V10.5Zm-12 0h.008v.008H6V10.5Z"></path>
                           </svg>
                        </div>
                     </div>
                     <p class="stats-number text-3xl font-bold text-gray-900 mb-2" id="omset-hari-ini">{omsetHariIni.length > 0 ? `Rp ${omsetHariIni[omsetHariIni.length-1][0]}` : '-'}</p>
                     <div class="flex items-center justify-between">
                        <p class="text-xs text-gray-600" id="omset-update-time">Dari Google Sheets</p>
                        <span class="text-xs font-medium px-2 py-1 bg-green-100 text-green-800 rounded-full">Hari Ini</span>
                     </div>
                  </div>
               </div>

               <!-- Omset Bulanan -->
               <div class="modern-card rounded-2xl p-6 shadow-lg overflow-hidden relative">
                  <div class="absolute top-0 right-0 w-24 h-24 -mr-8 -mt-8 bg-gradient-to-br from-amber-300/20 to-orange-400/20 rounded-full"></div>
                  <div class="relative z-10">
                     <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Omset Bulan Ini</h3>
                        <div class="w-10 h-10 flex items-center justify-center">
                           <svg class="w-10 h-10 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                           </svg>
                        </div>
                     </div>
                     <p class="stats-number text-3xl font-bold text-gray-900 mb-2" id="omset-bulanan">{omsetBulanIni ? `Rp ${omsetBulanIni}` : '-'}</p>
                     <div class="flex items-center justify-between">
                        <p class="text-xs text-gray-600" id="omset-bulanan-periode">0 hari dari Sheets</p>
                        <span class="text-xs font-medium px-2 py-1 bg-blue-100 text-blue-800 rounded-full">Bulan Ini</span>
                     </div>
                  </div>
               </div>

               <!-- Belanja Harian -->
               <div class="modern-card rounded-2xl p-6 shadow-lg overflow-hidden relative">
                  <div class="absolute top-0 right-0 w-24 h-24 -mr-8 -mt-8 bg-gradient-to-br from-amber-300/20 to-orange-400/20 rounded-full"></div>
                  <div class="relative z-10">
                     <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Belanja Hari Ini</h3>
                        <div class="w-10 h-10 flex items-center justify-center">
                           <svg class="w-10 h-10 text-orange-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                           </svg>
                        </div>
                     </div>
                     <p class="stats-number text-3xl font-bold text-gray-900 mb-2" id="belanja-hari-ini">{belanjaHariIni.length > 0 ? `Rp ${belanjaHariIni[belanjaHariIni.length-1][0]}` : '-'}</p>
                     <div class="flex items-center justify-between">
                        <p class="text-xs text-gray-600" id="belanja-update-time">Dari Google Sheets</p>
                        <span class="text-xs font-medium px-2 py-1 bg-orange-100 text-orange-800 rounded-full">Hari Ini</span>
                     </div>
                  </div>
               </div>
         </div>
         <div id="financial-section" class="hidden mb-6 sm:mb-8">
            <!-- Google Sheets Integration - Clean & Modern -->
            <div class="modern-card rounded-xl p-6 mb-3 shadow-lg">
               <!-- Header Section -->
               <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-green-500">
                  <div class="flex items-center gap-3">
                     <div class="w-10 h-10 rounded-lg flex items-center justify-center">
                        <svg class="w-8 h-8`` sm:6 sm:h-6 text-emerald-600" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-spreadsheet-icon lucide-file-spreadsheet"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M14 13h2"/><path d="M8 17h2"/><path d="M14 17h2"/></svg>
                     </div>
                     <div>
                        <h3 class="text-xl font-bold text-gray-900">Integrasi Google Sheets</h3>
                        <p class="text-sm text-gray-600">Sinkronisasi laporan keuangan otomatis</p>
                     </div>
                  </div>
                  <button id="sync-now-btn" class="hidden sm:flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
                     <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                     </svg>
                     <span>Sync</span>
                  </button>
               </div>

               <!-- Connection Status Card -->
               <div class="mb-6">
                  <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                     <div class="flex items-center gap-3">
                        <div id="connection-status-indicator" class="w-2.5 h-2.5 bg-gray-400 rounded-full flex-shrink-0"></div>
                        <span id="connection-status-text" class="text-sm font-medium text-gray-700">Belum tersambung</span>
                     </div>
                     <div class="flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-xs text-gray-500 font-medium" id="last-sync-time">-</span>
                     </div>
                  </div>
               </div>

               <!-- Quick Guide - Collapsible -->
               <details class="mb-6">
                  <summary class="flex items-center justify-between cursor-pointer p-3 bg-blue-50 rounded-lg">
                     <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-sm font-medium text-blue-900">Panduan Cepat</span>
                     </div>
                     <svg class="w-5 h-5 text-blue-600 transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                     </svg>
                  </summary>
                  <div class="mt-3 p-4 bg-white rounded-lg border border-blue-100">
                     <ol class="space-y-2.5">
                        <li class="flex items-start gap-3">
                           <span class="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-blue-600 text-white text-xs font-bold">1</span>
                           <span class="text-sm text-gray-700 pt-0.5">Buat atau buka Google Spreadsheet Anda</span>
                        </li>
                        <li class="flex items-start gap-3">
                           <span class="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-blue-600 text-white text-xs font-bold">2</span>
                           <span class="text-sm text-gray-700 pt-0.5">Salin URL spreadsheet dari browser</span>
                        </li>
                        <li class="flex items-start gap-3">
                           <span class="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-blue-600 text-white text-xs font-bold">3</span>
                           <span class="text-sm text-gray-700 pt-0.5">Tempel URL ke input di bawah dan klik Simpan</span>
                        </li>
                        <li class="flex items-start gap-3">
                           <span class="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-blue-600 text-white text-xs font-bold">4</span>
                           <span class="text-sm text-gray-700 pt-0.5">Data akan otomatis tersinkronisasi</span>
                        </li>
                     </ol>
                  </div>
               </details>

               <!-- Input Section -->
               <div class="space-y-4">
                  <div>
                     <label for="sheets-url-input" class="block text-sm font-medium text-gray-700 mb-2">
                        URL Google Spreadsheet
                     </label>
                     <div class="flex flex-col sm:flex-row gap-2">
                        <input 
                           type="url" 
                           id="sheets-url-input" 
                           placeholder="https://docs.google.com/spreadsheets/d/..." 
                           class="flex-1 px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                        >
                        <div class="flex gap-2">
                           <button 
                              id="save-sheets-url" 
                              class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors duration-200"
                           >
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                              </svg>
                              <span>Simpan</span>
                           </button>
                           <button 
                              id="open-sheets-btn" 
                              disabled 
                              class="flex items-center justify-center gap-2 px-4 py-2.5 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white text-sm font-medium rounded-lg transition-colors duration-200"
                           >
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                              </svg>
                              <span class="hidden sm:inline">Buka</span>
                           </button>
                        </div>
                     </div>
                     <div class="flex items-start ml-3 mt-2 gap-1">
                        <svg class="w-4 h-4 mt-2 mr-1 text-xs text-red-500" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-triangle-alert-icon lucide-triangle-alert"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                     <span class="pt-2 text-xs text-red-500">Pastikan spreadsheet dapat diakses oleh siapa saja dengan link</span>
                     </div>
                  </div>

                  <!-- Mobile Sync Button -->
                  <button id="sync-now-btn-mobile" class="sm:hidden w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors duration-200">
                     <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                     </svg>
                     <span>Sinkronisasi Sekarang</span>
                  </button>
               </div>
            </div>
                     <!-- Profile & Activity Section -->
                     <div class="modern-card rounded-xl p-6 shadow-lg mb-6">
                        <!-- Section Header -->
                        <div class="flex items-center gap-3 mb-6 pb-4 border-b-2 border-amber-500">
                           <div class="w-10 h-10 flex items-center justify-center">
                              <svg class="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                              </svg>
                           </div>
                           <div>
                              <h3 class="text-xl font-bold text-gray-900">Profil & Kemitraan</h3>
                              <p class="text-sm text-gray-600">Informasi lengkap akun Anda</p>
                           </div>
                        </div>

                        <!-- Info Grid - Simple & Clean -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                           <!-- Personal Info Items -->
                           <div class="info-item">
                              <div class="flex items-center gap-2 mb-1">
                                 <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                 </svg>
                                 <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Nama Lengkap</span>
                              </div>
                              <p class="text-sm font-semibold text-gray-900 pl-6" id="detail-nama">-</p>
                           </div>

                           <div class="info-item">
                              <div class="flex items-center gap-2 mb-1">
                                 <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                 </svg>
                                 <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Email</span>
                              </div>
                              <p class="text-sm font-semibold text-gray-900 pl-6 truncate" id="detail-email">-</p>
                           </div>

                           <div class="info-item">
                              <div class="flex items-center gap-2 mb-1">
                                 <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                 </svg>
                                 <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">No. Telepon</span>
                              </div>
                              <p class="text-sm font-semibold text-gray-900 pl-6" id="detail-hp">-</p>
                           </div>

                           <div class="info-item md:col-span-2 lg:col-span-3">
                              <div class="flex items-center gap-2 mb-1">
                                 <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                 </svg>
                                 <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Alamat</span>
                              </div>
                              <p class="text-sm font-semibold text-gray-900 pl-6" id="detail-alamat">-</p>
                           </div>
                        </div>

                        <!-- Divider -->
                        <div class="border-t border-gray-200 my-6"></div>

                        <!-- Partnership Info -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                           <div class="info-item">
                              <div class="flex items-center gap-2 mb-1">
                                 <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                 </svg>
                                 <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Sistem</span>
                              </div>
                              <p class="text-sm font-semibold text-gray-900 pl-6" id="detail-sistem">-</p>
                           </div>

                           <div class="info-item">
                              <div class="flex items-center gap-2 mb-1">
                                 <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                 </svg>
                                 <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Paket</span>
                              </div>
                              <p class="text-sm font-semibold text-gray-900 pl-6" id="detail-paket">-</p>
                           </div>

                           <div class="info-item">
                              <div class="flex items-center gap-2 mb-1">
                                 <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                 </svg>
                                 <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Pelunasan</span>
                              </div>
                              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 ml-10" id="detail-payment-badge">-</span>
                           </div>

                           <div class="info-item">
                              <div class="flex items-center gap-2 mb-1">
                                 <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                 </svg>
                                 <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Bergabung</span>
                              </div>
                              <p class="text-sm font-semibold text-gray-900 pl-6" id="detail-join-date">-</p>
                           </div>
                        </div>
                     </div>

                     <!-- Activity Timeline - Simple & Modern -->
                     <div class="modern-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-6">
                           <div class="w-10 h-10 flex items-center justify-center">
                              <svg class="w-8 h-8 text-green-500" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-activity-icon lucide-activity"><path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"/></svg>
                           </div>
                           <div class="flex-1">
                              <h3 class="text-xl font-bold text-gray-900">Aktivitas Akun</h3>
                              <p class="text-sm text-gray-600">Riwayat aktivitas terkini</p>
                           </div>
                           <div class="flex items-center gap-1.5 px-3 py-1.5 bg-red-50 rounded-full">
                              <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                              <span class="text-xs font-medium text-red-700">Live</span>
                           </div>
                        </div>

                        <div class="space-y-3">
                           <!-- Activity Item 1 -->
                           <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                              <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0 mt-0.5">
                                 <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                                 </svg>
                              </div>
                              <div class="flex-1 min-w-0">
                                 <p class="text-sm font-medium text-gray-900">Login Terakhir</p>
                                 <p class="text-xs text-gray-600 mt-0.5" id="last-login">-</p>
                              </div>
                           </div>

                           <!-- Activity Item 2 -->
                           <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                              <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 mt-0.5">
                                 <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                                 </svg>
                              </div>
                              <div class="flex-1 min-w-0">
                                 <p class="text-sm font-medium text-gray-900">Akun Dibuat</p>
                                 <p class="text-xs text-gray-600 mt-0.5" id="account-created">-</p>
                              </div>
                           </div>

                           <!-- Activity Item 3 -->
                           <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                              <div class="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0 mt-0.5">
                                 <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                 </svg>
                              </div>
                              <div class="flex-1 min-w-0">
                                 <p class="text-sm font-medium text-gray-900">Status Akun</p>
                                 <p class="text-xs text-gray-600 mt-0.5" id="account-status">Aktif</p>
                              </div>
                           </div>
                        </div>
                     </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
</div>

      <!-- Error State -->
      <div id="error-state" class="hidden text-center py-16">
         <div class="modern-card rounded-2xl p-10 shadow-xl max-w-lg mx-auto">
            <div class="icon-container danger w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
               <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
               </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-3">Gagal Memuat Data</h3>
            <p class="text-gray-600 mb-6" id="error-message">Terjadi kesalahan saat memuat data mitra.</p>
            <button onclick="window.location.reload()" class="px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-xl font-medium shadow-lg">
               Muat Ulang
            </button>
         </div>
      </div>
   </div>
</div>

<!-- Agreement Modal for New Users -->
<div id="agreement-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto bg-black bg-opacity-50" aria-labelledby="modal-title" role="dialog" aria-modal="true">
   <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <!-- Modal backdrop -->
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" id="modal-backdrop"></div>
      
      <!-- Modal panel -->
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full relative z-10">
         <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <div class="flex items-center mb-4">
               <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 sm:mx-0 sm:h-10 sm:w-10">
                  <svg class="w-10 h-10 sm:w-8 sm:h-8 text-amber-600" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-pen-line-icon lucide-clipboard-pen-line"><rect width="8" height="4" x="8" y="2" rx="1"/><path d="M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-.5"/><path d="M16 4h2a2 2 0 0 1 1.73 1"/><path d="M8 18h1"/><path d="M21.378 12.626a1 1 0 0 0-3.004-3.004l-4.01 4.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z"/></svg>
               </div>
               <div class="ml-3">
                  <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                     Selamat Datang di Sagawa Group
                  </h3>
                  <p class="text-sm text-gray-500">
                     Sebagai mitra baru, silakan baca dan setujui syarat dan ketentuan kemitraan
                  </p>
               </div>
            </div>

            <!-- Mitra Information Section -->
            <div class="mt-4 bg-green-50 border border-green-200 rounded-lg p-4 agreement-content">  
               <h4 class="font-semibold text-green-900 mb-3">Informasi Mitra</h4>
               
               <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="bg-white rounded-lg p-3 border border-green-200">
                     <label class="block text-xs font-medium text-gray-500 mb-1">Nama Lengkap</label>
                     <p class="text-sm font-semibold text-gray-900" id="agreement-nama">-</p>
                  </div>
                  
                  <div class="bg-white rounded-lg p-3 border border-green-200">
                     <label class="block text-xs font-medium text-gray-500 mb-1">Nomor HP</label>
                     <p class="text-sm font-semibold text-gray-900" id="agreement-no-hp">-</p>
                  </div>
                  
                  <div class="bg-white rounded-lg p-3 border border-green-200">
                     <label class="block text-xs font-medium text-gray-500 mb-1">Email</label>
                     <p class="text-sm font-semibold text-gray-900" id="agreement-email">-</p>
                  </div>
                  
                  <div class="bg-white rounded-lg p-3 border border-green-200">
                     <label class="block text-xs font-medium text-gray-500 mb-1">Sistem Kemitraan</label>
                     <p class="text-sm font-semibold text-gray-900" id="agreement-kemitraan">-</p>
                  </div>
                  
                  <div class="bg-white rounded-lg p-3 border border-green-200">
                     <label class="block text-xs font-medium text-gray-500 mb-1">Alamat</label>
                     <p class="text-sm font-semibold text-gray-900" id="agreement-alamat">-</p>
                  </div>
                  
                  <div class="bg-white rounded-lg p-3 border border-green-200">
                     <label class="block text-xs font-medium text-gray-500 mb-1">Nilai Paket Usaha</label>
                     <p class="text-sm font-semibold text-gray-900" id="agreement-nilai-paket">-</p>
                  </div>
               </div>
               
               <!-- Signature Declaration -->
               <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                  <p class="text-sm font-medium text-amber-800 text-center italic">
                     Saya sebagai Mitra Sagawa Group yang bertanda tangan di bawah ini:
                  </p>
               </div>
            </div>

            <!-- Agreement Content -->
            <div class="mt-3 sm:mt-0">
               <div class="bg-gray-50 rounded-lg p-6 max-h-96 overflow-y-auto agreement-content">
                  
                  <div class="space-y-4 text-sm text-gray-700">
                     <h4 class="font-semibold text-lg text-gray-900">SYARAT DAN KETENTUAN KEMITRAAN</h4>
                     
                     <div>
                        <h5 class="font-medium text-gray-900 mb-2">PASAL 1 KETENTUAN UMUM</h5>
                        <p class="mb-2">Masing-masing pihak, dalam hal ini Pihak I dan Pihak II bertanggung jawab atas tercapainya tujuan bersama dengan meningkatkan nilai bisnis maupun nilai merek. Harapan dari semua itu tidak lain untuk memperluas jangkauan bisnis dan konsistensi bisnis ke depannya.</p>
                     </div>
                     
                     <div>
                        <h5 class="font-medium text-gray-900 mb-2">PASAL 2 KEWAJIBAN POKOK PIHAK I</h5>
                        <p class="mb-2"><strong>Sebagai pemilik merek dan resep <span id="agreement-brand-name">(Nama Brand)</span>, Pihak I</strong></p>
                        <ul class="list-disc pl-5 mb-2 space-y-1">
                           <li>Membantu mencarikan properti usaha pada unit usaha Pihak II.</li>
                           <li>Memberikan pelatihan untuk karyawan baru Pihak II.</li>
                           <li>Memberikan pasokan bahan dasar dan bumbu resep asli dengan estimasi stok untuk beberapa waktu ke depan (suplay chain).</li>
                           <li>Meningkatkan kualitas karyawan pada unit usaha Pihak II.</li>
                           <li>Quality control produk atau menu dalam unit usaha Pihak II.</li>
                           <li>Quality control atas bahan baku menu yang dijual pada unit usaha Pihak II sesuai dengan standar operasional dan prosedur perusahaan.</li>
                           <li>Mengadakan pelatihan untuk meningkatkan kapasitas karyawan, melakukan riset dan pengembangan usaha, menjalankan misi marketing dan perluasan usaha.</li>
                           <li>Memberikan seragam kepada karyawan sebagai bentuk identitas usaha.</li>
                        </ul>
                     </div>
                     
                     <div>
                        <h5 class="font-medium text-gray-900 mb-2">PASAL 3 KEWAJIBAN POKOK PIHAK II</h5>
                        <p class="mb-2"><strong>Sebagai franchisee dan atau penerima hak waralaba (mitra) serta penanggung jawab Pihak II</strong></p>
                        <ul class="list-disc pl-5 mb-2 space-y-1">
                           <li>Berkewajiban membeli paket kemitraan dan memilih sistem operasional kemitraan, berlaku satu lokasi untuk satu brand.</li>
                           <li>Berkewajiban membeli bahan dasar inti dan bumbu asli resep kepada pihak I.</li>
                           <li>Berkewajiban Menjalankan fungsi manajemen usaha menuju tingkat profit usaha yang semakin tinggi.</li>
                           <li>Berkewajiban menjalankan asas usaha dengan berpedoman pada prinsip efektif dan efisien.</li>
                           <li>Berkewajiban untuk memberikan insentif kepada trainer (karyawan Pihak I) berupa uang minimal Rp. 250.000,-/hari jika lebih dari tiga hari dari masa training yang diberikan.</li>
                           <li>Pada sistem kemitraan semi-autopilot, Pihak II wajib membayarkan support fee/management fee kepada Pihak I setiap bulannya sebesar 5% (lima persen) dari laba kotor.</li>
                           <li>Pada sistem autopilot pihak II bersedia untuk membagi hasil dari profit bersih sebesar 40% kepada pihak pertama (pemililk lisensi) dan management fee sebesar 5% dari omset setiap bulannya.</li>
                           <li>Jika mitra diluar jabodetabek maka bersedia menanggug biaya diluar paket kemitraan seperti ongkos kirim equipment, survei lokasi, training, akomodasi dan lainnya (dirincikan dengan detail).</li>
                           <li>Pihak II sadar jika karyawan yang di berikan oleh pihak I adalah salah satu aset yang sewaktu-waktu bisa di pindah/bebas tugaskan oleh pihak I.</li>
                        </ul>
                     </div>
                     
                     <div>
                        <h5 class="font-medium text-gray-900 mb-2">PASAL 4 SKEMA BISNIS</h5>
                        <p class="mb-2">Setidaknya terdapat tiga macam sistem kemitraan yang berlaku dalam bisnis ini, yaitu Self-Managed, Semi Autopilot  dan Autopilot.</p>
                        <ul class="list-disc pl-5 mb-2 space-y-1">
                          <li>Sistem self-manage mengacu pada bisnis yang 100% dikelola oleh Pihak II dari segi operasional maupun finansial.</li>
                          <li>Dalam pengoperasiannya, Pihak II diperbolehkan bertanya ataupun meminta saran kepada Pihak I terkait dengan sistematika bisnis atau hal-hal yang menyangkut dengan administrasi maupun operasional bisnis.</li>
                          <li>Keuntungan (profit) bisnis dalam sistem kemitraan self-managed 100% milik Pihak II yang dalam hal ini adalah sebagai mitra (franchisee).</li>
                          <li>Segala bentuk kerugian dalam sistem kemitraan self-managed ditanggung oleh Pihak II selaku franchisee dan Pihak I diperbolehkan memberikan, masukan, saran dan segala bentuk support yang sifatnya solutif.</li>
                          <li>Sistem Semi-Autopilot mengacu pada bisnis yang sistem operasional bisnisnya dikelola 70-80% oleh Pihak I (Franchisor).</li>
                          <li>Sistem Autopilot adalah sistem dimana 100% dikelola oleh perusahaan/pihak I.</li>
                          <li>Sistem Semi Autopilot dan Autopilot Setiap bulannya, Pihak II akan mendapatkan laporan bulanan mengenai perkembangan bisnisnya dalam 30 hari sebelumnya yang sudah disiapkan oleh Pihak I, Selambat-lambatnya di lima hari setelah akhir bulan.</li>
                          <li>Management fee dalam sistem semi-autopilot sebesar 5% dari omset kotor disetiap bulannya, Skema ini berlaku selama bisnis masih berjalan.</li>
                          <li>Skema Autopilot keuntungan di bagi 40:60 (pihak I sebesar 40% dan pihak II sebesar 60% dari nett profit) dan management fee sebesar 5% pada sales kotor bulanan.</li>
                          <li>Pihak I akan membantu Pihak II dalam hal operasional bisnis dan senantiasa menjaga omzet agar tetap stabil, namun terbatas tanggung jawabnya terhadap pencapaian target profit bisnis dan BEP.</li>
                          <li>Jika pada unit bisnis dengan sistem autopilot mengalami kerugian maka pihak I dapat membantu mensuplay bahan baku (bumbu dasar) terlebih dahulu walapun belum dibayar (menghutangkan).</li>
                          <li>Semua tunduk atas aturan yang sudah dibuat.</li>
                        </ul>
                     </div>
                     
                     <div>
                        <h5 class="font-medium text-gray-900 mb-2">PASAL 7 LAIN-LAIN</h5>
                        <ul class="list-disc pl-5 mb-2 space-y-1">
                          <li>Perjanjian kerja sama ini berlaku sejak ditandatangani oleh kedua belah pihak.</li>
                          <li>Perjanjian kerja sama ini bersifat lifetime (selamanya), selama bisnis masih berjalan.</li>
                          <li>Bilamana terdapat kekeliruan, kelemahan dan kekurangan dalam surat perjanjian kerjasama ini, para pihak sepakat melakukan peninjauan ulang dan perbaikan berdasarkan musyawarah berasaskan kekeluargaan.</li>
                          <li>Hal-hal yang belum atau tidak diatur dalam surat perjanjian kerja sama ini akan diatur kembali berdasarkan kesepakatan para pihak.</li>
                          <li>Bilamana terjadi perselisihan, kedua belah pihak sepakat untuk menyelesaikan secara musyawarah/kekeluargaan.</li>
                          <li>Bilamana perselisihan tidak dapat diselesaikan melalui musyawarah, maka para pihak sepakat menyelesaikan melalui Pengadilan Negeri Indonesia.</li>
                        </ul>
                     </div>
                     <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <p class="text-sm text-amber-800">
                           <strong>Catatan:</strong> Surat perjanjian kerjasama ini dibuat dan ditandatangani oleh para pihak di atas materai secara silang dan memiliki kekuatan hukum yang sama.
                        </p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
         
         <!-- Agreement Checkbox and Submit -->
         <div class="bg-gray-50 px-4 py-3 sm:px-6">
            <div class="flex items-start mb-4">
               <div class="flex items-center h-5">
                  <input id="agreement-checkbox" type="checkbox" class="focus:ring-amber-500 h-4 w-4 text-amber-600 border-gray-300 rounded">
               </div>
               <div class="ml-3 text-sm">
                  <label for="agreement-checkbox" class="font-medium text-gray-700">
                     Saya telah membaca dan menyetujui seluruh syarat dan ketentuan kemitraan Sagawa Group
                  </label>
                  <p class="text-gray-500 text-xs mt-1">
                     Dengan mencentang kotak ini, Anda setuju untuk terikat dengan semua ketentuan yang berlaku
                  </p>
               </div>
            </div>
            
            <div class="flex justify-end">
               <button type="button" id="submit-agreement" disabled class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-gray-400 text-base font-medium text-white cursor-not-allowed sm:w-auto sm:text-sm transition-all duration-200">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Setuju dan Lanjutkan
               </button>
            </div>
         </div>
      </div>
   </div>
</div>

<script>
   // API URL configuration
   const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000';

   // Helper for per-user agreement storage key
   function agreementStorageKey() {
      const email = localStorage.getItem('mitraUserEmail');
      return email ? `mitraAgreementConfirmed:${email}` : 'mitraAgreementConfirmed';
   }

   document.addEventListener('DOMContentLoaded', async function() {
      // Prevent copying and text selection for all agreement content sections
      const agreementContents = document.querySelectorAll('.agreement-content');
      agreementContents.forEach(function(agreementContent) {
         // Prevent right-click context menu
         agreementContent.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
         });

         // Prevent keyboard shortcuts for copy/paste
         agreementContent.addEventListener('keydown', function(e) {
            const keyboardEvent = e as KeyboardEvent;
            // Prevent Ctrl+C, Ctrl+X, Ctrl+V, Ctrl+A
            if (keyboardEvent.ctrlKey && (keyboardEvent.key === 'c' || keyboardEvent.key === 'x' || keyboardEvent.key === 'v' || keyboardEvent.key === 'a')) {
               e.preventDefault();
               return false;
            }
            // Prevent F12 (developer tools)
            if (keyboardEvent.key === 'F12') {
               e.preventDefault();
               return false;
            }
         });

         // Prevent drag and drop
         agreementContent.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
         });
      });

      // Check authentication
      const token = localStorage.getItem('mitraToken');
      if (!token) {
         window.location.href = '/login';
         return;
      }

      // Initialize join date display
      const detailJoinDate = document.getElementById('detail-join-date');
      if (detailJoinDate) {
         detailJoinDate.textContent = 'Memuat...';
      } else {
         console.warn('[DEBUG] detail-join-date element not found during initialization');
      }
      (window as any).resetAgreement = function() {
         localStorage.removeItem(agreementStorageKey());
      };

      (window as any).showModal = function() {
         showAgreementModal();
      };

      (window as any).checkAgreementStatus = function() {
         const status = localStorage.getItem(agreementStorageKey());
         return status;
      };

      // Setup agreement modal for new users
      setupAgreementModal();

      // Initialize dashboard for overlay mode
      const initializeDashboard = () => {
         // Initialize dashboard for overlay mode (no margin management needed)
         initializeDashboardMargin();
         
         // Listen for sidebar toggle events (for potential future use)
         window.addEventListener('sidebarToggle', function(event: Event) {
            const customEvent = event as CustomEvent;
            const isVisible = customEvent.detail.visible;
            updateDashboardMargin(isVisible);
         });

         // Note: No resize handler needed for overlay mode
         // Dashboard content stays fixed regardless of sidebar state
      };

      // Ensure DOM is ready before initializing
      if (document.readyState === 'loading') {
         document.addEventListener('DOMContentLoaded', initializeDashboard);
      } else {
         initializeDashboard();
      }

      // Listen for navbar actions
      document.addEventListener('mitraNavbarAction', function(event: Event) {
        const customEvent = event as CustomEvent;
        const action = customEvent.detail.action;
        
        if (action === 'logout') {
          // Clear session data but keep remembered credentials
          localStorage.removeItem('mitraToken');
          localStorage.removeItem('mitraUser');
          localStorage.removeItem(agreementStorageKey());
          localStorage.removeItem('mitraUserEmail');
          
          // Keep remembered credentials for next login
          // localStorage.removeItem('rememberedEmail');
          // localStorage.removeItem('rememberedPassword');
          // localStorage.removeItem('rememberMe');
          
          window.location.href = '/login';
        }
      });

      // Load mitra profile data
      await loadMitraProfile();

      // Set up real-time activity updates
      setupRealTimeActivityUpdates();
   });

   // Helper to fetch profile robustly: try `/api/mitra/profile` then fallback to `/api/mitra/by-email`
   async function fetchProfileWithFallback(token: string | null) {
      if (!token) return null;
      // Try profile endpoint
      try {
         const res = await fetch(`${API_URL}/api/mitra/profile`, {
            method: 'GET',
            headers: {
               'Authorization': `Bearer ${token}`,
               'Content-Type': 'application/json'
            }
         });
         const json = await res.json();
         if (res.ok && json && json.success && json.data) return json.data;
      } catch (e) { /* ignore and fallback */ }

      // Fallback to by-email
      try {
         const email = localStorage.getItem('mitraUserEmail');
         if (!email) return null;
         const byEmailRes = await fetch(`${API_URL}/api/mitra/by-email?email=${encodeURIComponent(email)}`);
         if (!byEmailRes.ok) return null;
         const byEmailJson = await byEmailRes.json();
         return byEmailJson; // by-email returns the mitra object directly
      } catch (e) { return null; }
   }

   async function loadMitraProfile() {
      const loadingState = document.getElementById('loading-state');
      const dashboardContent = document.getElementById('dashboard-content');
      const errorState = document.getElementById('error-state');
      const token = localStorage.getItem('mitraToken');

      try {
         // Always try by-email endpoint first since it includes complete payment status information
         // as used in kewajiban.astro
         let data = null;
         const email = localStorage.getItem('mitraUserEmail');
         
         if (email) {
            try {
               const byEmailRes = await fetch(`${API_URL}/api/mitra/by-email?email=${encodeURIComponent(email)}`);
               if (byEmailRes.ok) {
                  const byEmailResult = await byEmailRes.json();
                  // the by-email route returns the mitra object directly
                  data = byEmailResult;
               } else {
                  console.warn('[WARN] /api/mitra/by-email failed, trying /api/mitra/profile');
               }
            } catch (e) {
               console.warn('[WARN] Error fetching /api/mitra/by-email, trying /api/mitra/profile', e);
            }
         }

         // Fallback to profile endpoint if by-email failed
         if (!data) {
            try {
               const response = await fetch(`${API_URL}/api/mitra/profile`, {
                  method: 'GET',
                  headers: {
                     'Authorization': `Bearer ${token}`,
                     'Content-Type': 'application/json'
                  }
               });
               const result = await response.json();

               if (response.ok && result && result.success && result.data) {
                  data = result.data;
               } else {
                  console.warn('[WARN] /api/mitra/profile did not return expected shape');
               }
            } catch (e) {
               console.warn('[WARN] Error fetching /api/mitra/profile', e);
            }
         }

         if (data) {
            // Store mitra data for agreement modal
            localStorage.setItem('mitraUser', JSON.stringify(data));
            (window as any).currentMitraData = data;
            
            // Hide loading state and show dashboard
            loadingState?.classList.add('hidden');
            dashboardContent?.classList.remove('hidden');

            // Update profile information in header and navbar
            updateProfileHeader(data);
            
            // Update navbar user info using the exposed function
            if (typeof (window as any).mitraNavbar !== 'undefined') {
              (window as any).mitraNavbar.updateUserInfo(data);
            }

            // Update statistics cards
            await updateStatisticsCards(data);

            // Update detailed information
            updateDetailedInfo(data);

            // Update activity information
            updateActivityInfo(data);

            // Agreement check is now handled in updateStatisticsCards when user is paid off
            // No need for separate call here to avoid duplication

         } else {
            throw new Error('Gagal memuat data profil');
         }

      } catch (error) {
         console.error('Error loading mitra profile:', error);
         
         // Show error state
         loadingState?.classList.add('hidden');
         errorState?.classList.remove('hidden');
         
         const errorMessage = document.getElementById('error-message');
         if (errorMessage) {
            errorMessage.textContent = error instanceof Error ? error.message : 'Terjadi kesalahan yang tidak diketahui';
         }
      }
   }

   // Function to set up real-time activity updates
   function setupRealTimeActivityUpdates() {
      // Update activity info every 30 seconds to show relative time changes
      setInterval(() => {
         const currentMitraData = (window as any).currentMitraData;
         if (currentMitraData) {
            updateActivityInfo(currentMitraData);
         }
      }, 30000); // Update every 30 seconds

      // Refresh profile data every 5 minutes to get latest server data
      setInterval(async () => {
         try {
            const token = localStorage.getItem('mitraToken');
            const email = localStorage.getItem('mitraUserEmail');
            
            if (!token || !email) return;

            // Fetch updated profile data quietly (without showing loading state)
            let data = null;
            
            try {
               const byEmailRes = await fetch(`${API_URL}/api/mitra/by-email?email=${encodeURIComponent(email)}`);
               if (byEmailRes.ok) {
                  data = await byEmailRes.json();
               }
            } catch (e) {
               // Fallback to profile endpoint
               try {
                  const response = await fetch(`${API_URL}/api/mitra/profile`, {
                     method: 'GET',
                     headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                     }
                  });
                  const result = await response.json();
                  if (response.ok && result?.success && result?.data) {
                     data = result.data;
                  }
               } catch (profileError) {
                  console.warn('Failed to refresh profile data:', profileError);
               }
            }

            if (data) {
               // Update stored data and activity info
               localStorage.setItem('mitraUser', JSON.stringify(data));
               (window as any).currentMitraData = data;
               updateActivityInfo(data);
               
               // Update other sections silently if needed
               updateStatisticsCards(data);
               updateDetailedInfo(data);
            }
         } catch (error) {
            console.warn('Error during background profile refresh:', error);
         }
      }, 300000); // Refresh every 5 minutes
   }

   // Function to initialize dashboard for overlay mode
   function initializeDashboardMargin() {
      // In overlay mode, we don't need to manage margins
      // Dashboard content stays fixed, sidebar appears as overlay
      console.log('Dashboard initialized for overlay mode');
   }

   // Function to update dashboard for overlay mode (placeholder for compatibility)
   function updateDashboardMargin(sidebarVisible: boolean) {
      // In overlay mode, dashboard content doesn't move
      // Sidebar appears/disappears as an overlay on top
      console.log('Sidebar overlay state:', sidebarVisible);
   }

   function setupAgreementModal() {
      // Setup checkbox handler
      const agreementCheckbox = document.getElementById('agreement-checkbox') as HTMLInputElement;
      const submitButton = document.getElementById('submit-agreement') as HTMLButtonElement;
      
      if (agreementCheckbox && submitButton) {
         agreementCheckbox.addEventListener('change', function() {
            if (this.checked) {
               submitButton.disabled = false;
               submitButton.className = 'inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-amber-600 text-base font-medium text-white cursor-pointer sm:w-auto sm:text-sm';
            } else {
               submitButton.disabled = true;
               submitButton.className = 'inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-gray-400 text-base font-medium text-white cursor-not-allowed sm:w-auto sm:text-sm transition-all duration-200';
            }
         });
         
         // Setup submit button handler
         submitButton.addEventListener('click', async function() {
            if (agreementCheckbox.checked) {
               // Accept agreement via modal
               try {
                  const token = localStorage.getItem('mitraToken');
                  if (!token) {
                     throw new Error('No authorization token');
                  }

                  // Collect all mitra information from the agreement modal
                  const mitraData = {
                     namaMitra: document.getElementById('agreement-nama')?.textContent || '',
                     noHp: document.getElementById('agreement-no-hp')?.textContent || '',
                     email: document.getElementById('agreement-email')?.textContent || '',
                     sistemKemitraan: document.getElementById('agreement-kemitraan')?.textContent || '',
                     alamat: document.getElementById('agreement-alamat')?.textContent || '',
                     nilaiPaketUsaha: document.getElementById('agreement-nilai-paket')?.textContent || '',
                     acceptedAt: new Date().toISOString(),
                     userAgent: navigator.userAgent,
                     ipAddress: 'client-side',
                     agreementVersion: '1.0',
                     agreementContent: {
                        title: 'SYARAT DAN KETENTUAN KEMITRAAN',
                        signatureDeclaration: 'Saya yang sebagai Mitra Sagawa Group yang bertanda tangan di bawah ini:',
                        acceptedTerms: true
                     }
                  };

                  const response = await fetch(`${API_URL}/api/mitra/accept-agreement`, {
                     method: 'POST',
                     headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                     },
                     body: JSON.stringify(mitraData)
                  });

                  const result = await response.json();
                  
                  if (response.ok && result.success) {
                     
                     // Cache agreement status (per-user)
                     localStorage.setItem(agreementStorageKey(), 'true');
                     
                     // Show success message
                     showNotification('Terima kasih! Perjanjian telah diterima dan disimpan. Anda sekarang resmi menjadi mitra Sagawa Group.', 'success');
                     
                     // Hide modal
                     hideAgreementModal();
                     
                     // Reload profile to update status
                     await loadMitraProfile();
                  } else {
                     throw new Error(result.error || 'Failed to save agreement');
                  }
               } catch (error) {
                  console.error('Error accepting agreement from modal:', error);
                  showNotification('Gagal menyimpan persetujuan. Silakan coba lagi.', 'error');
               }
            }
         });
      }
   }

   // Small helper to determine if a user/mitra is considered paid off.
   function isUserPaidOff(user: any) {
         // Hardened rule: parse numeric-like strings (e.g. "1.234,00" or "1234")
         // and check several alternate field names used across backends.
         if (!user) return false;

         const parseNumber = (v: any) => {
            if (v === null || typeof v === 'undefined') return null;
            if (typeof v === 'number') return v;
            if (typeof v === 'string') {
               // remove anything except digits, minus, dot and comma
               const cleaned = v.replace(/[^0-9.,-]/g, '');
               if (cleaned === '') return null;
               // If comma used as decimal separator (e.g. '1.234,56'), convert to '1234.56'
               const commaCount = (cleaned.match(/,/g) || []).length;
               const dotCount = (cleaned.match(/\./g) || []).length;
               let normalized = cleaned;
               if (commaCount > 0 && dotCount > 0 && cleaned.indexOf(',') > cleaned.indexOf('.')) {
                  // format like '1.234,56' -> remove dots and replace comma with dot
                  normalized = cleaned.replace(/\./g, '').replace(/,/g, '.');
               } else if (commaCount > 0 && dotCount === 0) {
                  // format like '1234,56' -> replace comma with dot
                  normalized = cleaned.replace(/,/g, '.');
               } else {
                  // remove all commas
                  normalized = cleaned.replace(/,/g, '');
               }
               const n = parseFloat(normalized);
               return isNaN(n) ? null : n;
            }
            return null;
         };

         // Try multiple possible field names
         const rawKekurangan = user.kekurangan ?? user.sisa ?? user.sisaPembayaran ?? user.sisa_pelunasan ?? null;
         const kekuranganNum = parseNumber(rawKekurangan);
         const isKekuranganZero = kekuranganNum !== null && kekuranganNum <= 0;

         // numeric comparison: total paid vs package price
         const totalPaid = parseNumber(user.totalPaid ?? user.paidAmount ?? user.total_pembayaran ?? user.jumlahPembayaran ?? user.pembayaranTotal ?? null);
         const packagePrice = parseNumber(user.hargaPaket ?? user.nilaiPaketUsaha ?? user.totalPrice ?? user.totalHarga ?? user.harga ?? null);
         const paidByComparison = (totalPaid !== null && packagePrice !== null && totalPaid >= packagePrice);

         // Collect various status fields (backend may use different shapes)
         const pelunasanStatuses: string[] = [];
         try {
            if (Array.isArray(user?.pelunasan)) {
               user.pelunasan.forEach((p: any) => {
                  if (p && p.status) pelunasanStatuses.push(String(p.status).toLowerCase());
                  if (p && typeof p.isPaid !== 'undefined' && p.isPaid === true) pelunasanStatuses.push('paid');
               });
            } else if (user?.pelunasan && typeof user.pelunasan === 'object' && user.pelunasan.status) {
               pelunasanStatuses.push(String(user.pelunasan.status).toLowerCase());
            }
            if (user?.statusPelunasan) pelunasanStatuses.push(String(user.statusPelunasan).toLowerCase());
            if (user?.pelunasanStatus) pelunasanStatuses.push(String(user.pelunasanStatus).toLowerCase());
            if (user?.paymentStatus) pelunasanStatuses.push(String(user.paymentStatus).toLowerCase());
            if (user?.keteranganPelunasan) pelunasanStatuses.push(String(user.keteranganPelunasan).toLowerCase());
         } catch (e) { /* ignore */ }

         const isPelunasanApproved = (
            user?.pelunasanApproved === true ||
            pelunasanStatuses.includes('approved') ||
            pelunasanStatuses.includes('lunas') ||
            pelunasanStatuses.includes('paid') ||
            // Some backends may use explicit status fields for payment
            (typeof user?.statusPelunasan === 'string' && ['approved', 'lunas', 'paid'].includes(user.statusPelunasan.toLowerCase()))
         );

         const isPaidOff = (
            user?.nilaiPaketUsaha === 'Full Payment' ||
            user?.isFullPayment === true ||
            user?.isPaidOff === true ||
            isPelunasanApproved ||
            isKekuranganZero ||
            paidByComparison
         );

         // Debug: show which check matched in the current environment with parsed numeric values
         try {
            console.debug('[DEBUG] isUserPaidOff check', {
               rawKekurangan,
               kekuranganNum,
               totalPaid,
               packagePrice,
               paidByComparison,
               nilaiPaketUsaha: user?.nilaiPaketUsaha,
               isFullPayment: user?.isFullPayment,
               isPaidOffField: user?.isPaidOff,
               pelunasanApproved: user?.pelunasanApproved,
               statusPelunasan: user?.statusPelunasan,
               pelunasanStatuses,
               isKekuranganZero,
               result: Boolean(isPaidOff)
            });
         } catch (e) { /* ignore */ }

         return Boolean(isPaidOff);
   }

   // Check agreement status; if `userProfile` is supplied we use it (avoids double fetching when
   // called after loadMitraProfile), otherwise we'll fetch the profile ourselves.
   async function checkAgreementStatusFromBackend(userProfile: any = null) {
      try {
         const token = localStorage.getItem('mitraToken');
         if (!token) return;

         // Check if we already have cached agreement status for this session
         // Check if we already have cached agreement status for this session (per-user)
         const cachedAgreementStatus = localStorage.getItem(agreementStorageKey());
         if (cachedAgreementStatus === 'true') {
            return;
         }

         // Use provided profile when available to determine payment status
         let user = userProfile;
         if (!user) {
            // try the same fallback we use in loadMitraProfile
            user = await fetchProfileWithFallback(token);
            if (!user) {
               console.error('Gagal memuat profil user untuk cek pelunasan');
               return;
            }
         }

         // DEV DEBUG: inspect the profile used to decide payment status
         console.debug('[DEBUG] checkAgreementStatusFromBackend - userProfile:', user);

         // Only run agreement checks for users who have completed payment
         // Use the same logic as in updateStatisticsCards to ensure consistency
         const parseNumber = (v: any) => {
            if (v === null || typeof v === 'undefined') return null;
            if (typeof v === 'number') return v;
            if (typeof v === 'string') {
               const cleaned = v.replace(/[^0-9.,-]/g, '');
               if (cleaned === '') return null;
               const commaCount = (cleaned.match(/,/g) || []).length;
               const dotCount = (cleaned.match(/\./g) || []).length;
               let normalized = cleaned;
               if (commaCount > 0 && dotCount > 0 && cleaned.indexOf(',') > cleaned.indexOf('.')) {
                  normalized = cleaned.replace(/\./g, '').replace(/,/g, '.');
               } else if (commaCount > 0 && dotCount === 0) {
                  normalized = cleaned.replace(/,/g, '.');
               } else {
                  normalized = cleaned.replace(/,/g, '');
               }
               const n = parseFloat(normalized);
               return isNaN(n) ? null : n;
            }
            return null;
         };

         const rawKekurangan = user.kekurangan ?? user.sisa ?? user.sisaPembayaran ?? user.sisa_pelunasan ?? null;
         const kekuranganNum = parseNumber(rawKekurangan);
         const isKekuranganZero = kekuranganNum !== null && kekuranganNum <= 0;

         const totalPaid = parseNumber(user.totalPaid ?? user.paidAmount ?? user.total_pembayaran ?? user.jumlahPembayaran ?? user.pembayaranTotal ?? null);
         const packagePrice = parseNumber(user.hargaPaket ?? user.nilaiPaketUsaha ?? user.totalPrice ?? user.totalHarga ?? user.harga ?? null);
         const paidByComparison = (totalPaid !== null && packagePrice !== null && totalPaid >= packagePrice);

         const pelunasanStatuses = [];
         try {
            if (Array.isArray(user?.pelunasan)) {
               user.pelunasan.forEach((p: any) => {
                  if (p && typeof p.isPaid !== 'undefined' && p.isPaid === true) pelunasanStatuses.push('paid');
               });
            } else if (user?.pelunasan && typeof user.pelunasan === 'object' && user.pelunasan.status) {
               pelunasanStatuses.push(String(user.pelunasan.status).toLowerCase());
            }
            if (user?.statusPelunasan) pelunasanStatuses.push(String(user.statusPelunasan).toLowerCase());
            if (user?.pelunasanStatus) pelunasanStatuses.push(String(user.pelunasanStatus).toLowerCase());
            if (user?.paymentStatus) pelunasanStatuses.push(String(user.paymentStatus).toLowerCase());
            if (user?.keteranganPelunasan) pelunasanStatuses.push(String(user.keteranganPelunasan).toLowerCase());
         } catch (e) { /* ignore */ }

         const isPelunasanApproved = (
            user?.pelunasanApproved === true ||
            pelunasanStatuses.includes('approved') ||
            pelunasanStatuses.includes('lunas') ||
            pelunasanStatuses.includes('paid') ||
            (typeof user?.statusPelunasan === 'string' && ['approved', 'lunas', 'paid'].includes(user.statusPelunasan.toLowerCase()))
         );

         const userIsPaidOff = (
            user?.nilaiPaketUsaha === 'Full Payment' ||
            user?.isFullPayment === true ||
            user?.isPaidOff === true ||
            isPelunasanApproved ||
            isKekuranganZero ||
            paidByComparison
         );

         if (!userIsPaidOff) {
            return;
         }

         const response = await fetch(`${API_URL}/api/mitra/agreement-status`, {
            method: 'GET',
            headers: {
               'Authorization': `Bearer ${token}`,
               'Content-Type': 'application/json'
            }
         });

         const result = await response.json();

         if (response.ok && result.success) {
            const { hasAccepted, agreementDetails } = result.data;

            // Ensure the agreement (if present) belongs to this user
            let acceptedForThisUser = hasAccepted;
            try {
               const localUserId = user && (user._id || user.id || user.mitraId || user.mitra_id);
               const remoteMitraId = agreementDetails && (agreementDetails.mitraId || agreementDetails.mitra_id);
               if (hasAccepted && remoteMitraId && localUserId && String(remoteMitraId) !== String(localUserId)) {
                  console.warn('Agreement record mitraId mismatch  ignoring remote acceptance for this session', { remoteMitraId, localUserId });
                  acceptedForThisUser = false;
               }
            } catch (e) { /* ignore */ }

            if (!acceptedForThisUser) {
               // Agreement now only appears as modal
               setTimeout(() => { showAgreementModal(); }, 300);
            } else {
               const agreedAt = agreementDetails?.acceptedAt;
               // Persist per-user cache
               localStorage.setItem(agreementStorageKey(), 'true');
            }
         } else {
            console.error('Failed to check agreement status:', result.error);
            // If backend fails, don't show modal to avoid blocking user
         }

      } catch (error) {
         console.error('Error checking agreement status:', error);
         // If backend fails, don't show modal to avoid blocking user
      }
   }

   function showAgreementModal() {
      const modal = document.getElementById('agreement-modal');
      
      if (modal) {
         
         // Remove hidden class and add animation
         modal.classList.remove('hidden');
         modal.style.display = 'block';
         
         // Prevent background scrolling
         document.body.style.overflow = 'hidden';
         
         // Focus on the modal for accessibility
         setTimeout(() => {
            modal.focus();
         }, 100);
         
         // Add animation effect
         setTimeout(() => {
            modal.style.opacity = '1';
         }, 10);
         
         // Update mitra information in the modal
         updateAgreementModalWithCurrentData();
         
      } else {
         console.error('[DEBUG] Modal element NOT found!');
      }
   }

   function hideAgreementModal() {

      const modal = document.getElementById('agreement-modal');
      if (modal) {
         // Add fade out animation
         modal.style.opacity = '0';
         
         setTimeout(() => {
            modal.classList.add('hidden');
            modal.style.display = 'none';
            
            // Restore background scrolling
            document.body.style.overflow = '';
         }, 300);
      }
   }

   // Function to update agreement modal with current mitra data
   function updateAgreementModalWithCurrentData() {
      try {
         // Try to get mitra data from localStorage first
         const mitraDataString = localStorage.getItem('mitraUser');
         let mitraData = null;

         if (mitraDataString) {
            mitraData = JSON.parse(mitraDataString);
         }

         // If no data in localStorage, try to get from current session data
         if (!mitraData) {
            // Try to get from window object if available (from previous loads)
            const windowData = (window as any).currentMitraData;
            if (windowData) {
               mitraData = windowData;
            }
         }

         // If we have mitra data, update the modal
         if (mitraData) {
            updateAgreementModalInfo(mitraData);
         } else {
            console.warn('[DEBUG] No mitra data available for agreement modal');
            // Set default values
            updateAgreementModalInfo({
               namaMitra: 'Data tidak tersedia',
               noHp: 'Data tidak tersedia',
               email: localStorage.getItem('mitraUserEmail') || 'Data tidak tersedia',
               sistemKemitraan: 'Data tidak tersedia',
               paketUsaha: '',
               alamatMitra: 'Data tidak tersedia',
               hargaPaket: 'Data tidak tersedia'
            });
         }
      } catch (error) {
         console.error('[DEBUG] Error updating agreement modal with current data:', error);
         // Set default values on error
         updateAgreementModalInfo({
            namaMitra: 'Error memuat data',
            noHp: 'Error memuat data',
            email: 'Error memuat data',
            sistemKemitraan: 'Error memuat data',
            paketUsaha: '',
            alamatMitra: 'Error memuat data',
            hargaPaket: 'Error memuat data'
         });
      }
   }

   // Function to update mitra information in agreement modal
   function updateAgreementModalInfo(mitraData: any) {

      // Update Nama
      const namaElement = document.getElementById('agreement-nama');
      if (namaElement) {
         namaElement.textContent = mitraData?.nama || mitraData?.namaMitra || 'Tidak tersedia';
      }

      // Update No HP
      const noHpElement = document.getElementById('agreement-no-hp');
      if (noHpElement) {
         noHpElement.textContent = mitraData?.noHp || mitraData?.nomorHp || mitraData?.phone || 'Tidak tersedia';
      }

      // Update Email
      const emailElement = document.getElementById('agreement-email');
      if (emailElement) {
         emailElement.textContent = mitraData?.email || 'Tidak tersedia';
      }

      // Update Sistem Kemitraan
      const kemitraanElement = document.getElementById('agreement-kemitraan');
      if (kemitraanElement) {
         const sistemKemitraan = mitraData?.sistemKemitraan || 'Tidak tersedia';
         const paketUsaha = mitraData?.paketUsaha ? ` - ${mitraData.paketUsaha}` : '';
         kemitraanElement.textContent = sistemKemitraan + paketUsaha;
      }

      // Update Alamat
      const alamatElement = document.getElementById('agreement-alamat');
      if (alamatElement) {
         alamatElement.textContent = mitraData?.alamatMitra || mitraData?.alamat || mitraData?.address || 'Tidak tersedia';
      }

      // Update Nilai Paket Usaha
      const nilaiPaketElement = document.getElementById('agreement-nilai-paket');
      if (nilaiPaketElement) {
         let nilaiPaket = mitraData?.hargaPaket || mitraData?.nilaiPaketUsaha || mitraData?.totalPrice || mitraData?.harga || 'Tidak tersedia';
         
         // Format as currency if it's a number
         if (typeof nilaiPaket === 'number') {
            nilaiPaket = nilaiPaket.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' });
         } else if (typeof nilaiPaket === 'string' && !isNaN(Number(nilaiPaket))) {
            nilaiPaket = Number(nilaiPaket).toLocaleString('id-ID', { style: 'currency', currency: 'IDR' });
         }
         
         nilaiPaketElement.textContent = nilaiPaket;
      }

      // Update Brand Name in agreement text
      const brandNameElement = document.getElementById('agreement-brand-name');
      if (brandNameElement) {
         // Use business package as brand name, fallback to partnership system if not available
         const brandName = mitraData?.paketUsaha || mitraData?.namaPaket || mitraData?.brandName || mitraData?.sistemKemitraan || 'Sagawa Group';
         brandNameElement.textContent = brandName;
      }
   }

   // Agreement will now only appear as modal - dashboard agreement functions removed

   function showNotification(message: string, type: 'success' | 'error' = 'success') {
      // Create notification element
      const notification = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
      
      notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full opacity-0`;
      notification.innerHTML = `
         <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               ${type === 'success' 
                  ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'
                  : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
               }
            </svg>
            <span>${message}</span>
         </div>
      `;
      
      // Add to DOM
      document.body.appendChild(notification);
      
      // Animate in
      setTimeout(() => {
         notification.classList.remove('translate-x-full', 'opacity-0');
      }, 100);
      
      // Remove after 3 seconds
      setTimeout(() => {
         notification.classList.add('translate-x-full', 'opacity-0');
         setTimeout(() => {
            if (notification.parentNode) {
               notification.parentNode.removeChild(notification);
            }
         }, 300);
      }, 3000);
   }

   // Agreement will now only appear as modal - dashboard agreement functions removed

   function updateProfileHeader(data: any) {
      // Store user email for agreement modal detection
      if (data.email) {
         localStorage.setItem('mitraUserEmail', data.email);
      }

      // Update avatar with first letter of name - support both nama and namaMitra fields
      const profileAvatar = document.getElementById('profile-avatar');
      const displayName = data.nama || data.namaMitra || 'M';
      const firstLetter = displayName.charAt(0).toUpperCase();
      
      if (profileAvatar) profileAvatar.textContent = firstLetter;

      // Update profile info with dynamic greeting
      const profileName = document.getElementById('profile-name');
      const profileEmail = document.getElementById('profile-email');
      const profileStatus = document.getElementById('profile-status');
      const greetingTime = document.getElementById('greeting-time');
      const welcomeMessage = document.getElementById('welcome-message');
      const joinBadge = document.getElementById('join-badge');
      const joinDateText = document.getElementById('join-date-text');

      // Dynamic greeting based on time
      const hour = new Date().getHours();
      let greeting = 'Selamat Datang';
      if (hour >= 5 && hour < 11) greeting = 'Selamat Pagi';
      else if (hour >= 11 && hour < 15) greeting = 'Selamat Siang';
      else if (hour >= 15 && hour < 18) greeting = 'Selamat Sore';
      else greeting = 'Selamat Malam';

      if (greetingTime) greetingTime.textContent = greeting;
      if (profileName) profileName.textContent = displayName || 'Mitra Sagawa Group';
      if (profileEmail) profileEmail.textContent = data.email || 'Email tidak tersedia';

      // Welcome message based on approval status
      if (welcomeMessage) {
         if (data.isApproved) {
            welcomeMessage.textContent = 'Mari bersama-sama berkembang dan meraih kesuksesan bersama Sagawa Group! ';
         } else if (data.status === 'pending') {
            welcomeMessage.textContent = 'Terima kasih telah mendaftar. Kami sedang memproses persetujuan kemitraan Anda.';
         } else {
            welcomeMessage.textContent = 'Terima kasih telah bergabung dengan keluarga besar Sagawa Group';
         }
      }

      // Join date badge
      if (joinBadge && joinDateText) {
         const joinDate = data.joinDate || data.createdAt || data.created_at;
         if (joinDate) {
            const date = new Date(joinDate);
            const monthYear = date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            joinDateText.textContent = monthYear;
            joinBadge.style.display = 'inline-flex';
         }
      }

      // Status badge
      if (profileStatus) {
         let statusText = 'Status tidak diketahui';
         if (data.isApproved) {
            statusText = ' Mitra Disetujui';
         } else if (data.status === 'pending') {
            statusText = ' Menunggu Persetujuan';
         } else if (data.status === 'rejected') {
            statusText = ' Ditolak';
         }
         profileStatus.textContent = statusText;
      }
   }

   async function updateStatisticsCards(data: any) {
      // Kemitraan Status
      const kemitraanStatus = document.getElementById('kemitraan-status');
      if (kemitraanStatus) {
         let status = 'Pending';
         if (data.isApproved) {
            status = 'Aktif';
         } else if (data.status === 'rejected') {
            status = 'Ditolak';
         }
         kemitraanStatus.textContent = status;
      }

      // Status Pelunasan
      const pelunasanStatus = document.getElementById('pelunasan-status');
      const pelunasanStatusLabel = pelunasanStatus?.previousElementSibling;
      if (pelunasanStatus) {
         // Use the same logic as in kewajiban.astro
         const hasKekurangan = data && typeof data.kekurangan !== 'undefined' && data.kekurangan !== null;
         const isKekuranganZero = hasKekurangan && !isNaN(Number(data.kekurangan)) && Number(data.kekurangan) <= 0;

         // Parse numeric values for comparison (same as isUserPaidOff function)
         const parseNumber = (v: any) => {
            if (v === null || typeof v === 'undefined') return null;
            if (typeof v === 'number') return v;
            if (typeof v === 'string') {
               const cleaned = v.replace(/[^0-9.,-]/g, '');
               if (cleaned === '') return null;
               const commaCount = (cleaned.match(/,/g) || []).length;
               const dotCount = (cleaned.match(/\./g) || []).length;
               let normalized = cleaned;
               if (commaCount > 0 && dotCount > 0 && cleaned.indexOf(',') > cleaned.indexOf('.')) {
                  normalized = cleaned.replace(/\./g, '').replace(/,/g, '.');
               } else if (commaCount > 0 && dotCount === 0) {
                  normalized = cleaned.replace(/,/g, '.');
               } else {
                  normalized = cleaned.replace(/,/g, '.');
               }
               const n = parseFloat(normalized);
               return isNaN(n) ? null : n;
            }
            return null;
         };

         const totalPaid = parseNumber(data.totalPaid ?? data.paidAmount ?? data.total_pembayaran ?? data.jumlahPembayaran ?? data.pembayaranTotal ?? null);
         const packagePrice = parseNumber(data.hargaPaket ?? data.nilaiPaketUsaha ?? data.totalPrice ?? data.totalHarga ?? data.harga ?? null);
         const paidByComparison = (totalPaid !== null && packagePrice !== null && totalPaid >= packagePrice);

         const pelunasanStatuses = [];
         try {
            if (Array.isArray(data?.pelunasan)) {
               data.pelunasan.forEach((p: any) => {
                  if (p && typeof p.isPaid !== 'undefined' && p.isPaid === true) pelunasanStatuses.push('paid');
               });
            } else if (data?.pelunasan && typeof data.pelunasan === 'object' && data.pelunasan.status) {
               pelunasanStatuses.push(String(data.pelunasan.status).toLowerCase());
            }
            if (data?.statusPelunasan) pelunasanStatuses.push(String(data.statusPelunasan).toLowerCase());
            if (data?.pelunasanStatus) pelunasanStatuses.push(String(data.pelunasanStatus).toLowerCase());
            if (data?.paymentStatus) pelunasanStatuses.push(String(data.paymentStatus).toLowerCase());
            if (data?.keteranganPelunasan) pelunasanStatuses.push(String(data.keteranganPelunasan).toLowerCase());
         } catch (e) { /* ignore shape issues */ }

         // Only treat payment-specific approval signals as pelunasan approved.
         const isPelunasanApproved = (
            data?.pelunasanApproved === true ||
            pelunasanStatuses.includes('approved') ||
            pelunasanStatuses.includes('lunas') ||
            pelunasanStatuses.includes('paid') ||
            (typeof data?.statusPelunasan === 'string' && ['approved', 'lunas', 'paid'].includes(data.statusPelunasan.toLowerCase()))
         );

         const isPaidOff = (
            data?.nilaiPaketUsaha === 'Full Payment' ||
            data?.isFullPayment === true ||
            data?.isPaidOff === true ||
            isPelunasanApproved ||
            isKekuranganZero ||
            paidByComparison
         );

         // Additional simple check for "Lunas" status
         const hasLunasStatus = (
            String(data?.statusPelunasan).toLowerCase() === 'lunas' ||
            String(data?.pelunasanStatus).toLowerCase() === 'lunas' ||
            String(data?.paymentStatus).toLowerCase() === 'lunas' ||
            (data?.pelunasan && String(data.pelunasan.status).toLowerCase() === 'lunas')
         );

         // Force show agreement if status is explicitly "Lunas" or isPaidOff is true
         const shouldShowAgreement = isPaidOff || hasLunasStatus;

         // Debug logging

         if (shouldShowAgreement) {
            // Show explicitly as "Lunas" and keep element visible so user sees the status
            pelunasanStatus.textContent = 'Lunas';
            pelunasanStatus.className = 'text-green-600 font-bold';
            pelunasanStatus.style.display = '';
            if (pelunasanStatusLabel && pelunasanStatusLabel instanceof HTMLElement) pelunasanStatusLabel.style.display = '';
            
            // Agreement will now only appear as modal - no inline dashboard section
            
            // Check agreement status from backend and show modal if needed
            await checkAgreementStatusFromBackend(data);
         } else {
            pelunasanStatus.textContent = 'Belum Lunas';
            pelunasanStatus.className = 'text-red-600 font-bold';
            pelunasanStatus.style.display = '';
            if (pelunasanStatusLabel && pelunasanStatusLabel instanceof HTMLElement) pelunasanStatusLabel.style.display = '';
            
            // Agreement section removed from dashboard - no need to hide
         }
      }

      // Sistem Kemitraan
      const sistemKemitraan = document.getElementById('sistem-kemitraan');
      if (sistemKemitraan) {
         sistemKemitraan.textContent = data.sistemKemitraan || 'Tidak tersedia';
      }

      // Paket Usaha
      const paketUsaha = document.getElementById('paket-usaha');
      if (paketUsaha) {
         paketUsaha.textContent = data.paketUsaha || 'Tidak tersedia';
      }

      // Nilai Paket (ambil dari hargaPaket) - Update both mobile and desktop
      const nilaiPaket = document.getElementById('nilai-paket');
      const nilaiPaketHeader = document.getElementById('nilai-paket-header');
      if (nilaiPaket || nilaiPaketHeader) {
         let harga = data.hargaPaket;
         let formattedHarga = 'Tidak tersedia';
         if (typeof harga === 'number') {
            formattedHarga = harga.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' });
         }
         if (nilaiPaket) nilaiPaket.textContent = formattedHarga;
         if (nilaiPaketHeader) nilaiPaketHeader.textContent = formattedHarga;
      }

      // Show financial section only for Autopilot & Semi Autopilot
      const financialSection = document.getElementById('financial-section');
      const financialSummaryCards = document.getElementById('financial-summary-cards');
      const sistemKemitraanText = data.sistemKemitraan?.toLowerCase() || '';
      
      // Check if user is self-managed (hide financial reports)
      const isSelfManaged = sistemKemitraanText.includes('self') || sistemKemitraanText.includes('managed');
      
      if (financialSection && (sistemKemitraanText.includes('autopilot') || sistemKemitraanText.includes('semi'))) {
         financialSection.classList.remove('hidden');
         updateFinancialSummary(data);
         initializeFinancialSection();
      } else if (financialSection) {
         financialSection.classList.add('hidden');
      }
      
      // Hide financial summary cards for self-managed mitra
      if (financialSummaryCards) {
         if (isSelfManaged) {
            financialSummaryCards.classList.add('hidden');
         } else {
            financialSummaryCards.classList.remove('hidden');
         }
      }
   }

   function updateFinancialSummary(data: any) {
      // Mock data untuk demo - nanti bisa diambil dari API yang sesuai
      const omsetHarian = Math.random() * 5000000; // Simulasi omset harian
      const omsetBulanan = Math.random() * 100000000; // Simulasi omset bulanan
      const belanjaHarian = Math.random() * 2000000; // Simulasi belanja harian

      // Update Omset Harian
      const omsetHarianElement = document.getElementById('omset-harian');
      if (omsetHarianElement) {
         omsetHarianElement.textContent = omsetHarian.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' });
      }

      // Update Omset Bulanan
      const omsetBulananElement = document.getElementById('omset-bulanan');
      if (omsetBulananElement) {
         omsetBulananElement.textContent = omsetBulanan.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' });
      }

      // Update Belanja Harian
      const belanjaHarianElement = document.getElementById('belanja-harian');
      if (belanjaHarianElement) {
         belanjaHarianElement.textContent = belanjaHarian.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' });
      }

   }

   function updateDetailedInfo(data: any) {
      // Personal Information
      const detailNama = document.getElementById('detail-nama');
      const detailEmail = document.getElementById('detail-email');
      const detailHp = document.getElementById('detail-hp');
      const detailAlamat = document.getElementById('detail-alamat');

      if (detailNama) detailNama.textContent = data.nama || data.namaMitra || 'Tidak tersedia';
      if (detailEmail) detailEmail.textContent = data.email || 'Tidak tersedia';
      if (detailHp) detailHp.textContent = data.noHp || 'Tidak tersedia';
      if (detailAlamat) detailAlamat.textContent = data.alamatMitra || 'Tidak tersedia';

      // Partnership Information
      const detailSistem = document.getElementById('detail-sistem');
      const detailPaket = document.getElementById('detail-paket');
      const detailSales = document.getElementById('detail-sales');
      const detailPaymentBadge = document.getElementById('detail-payment-badge');
      const detailJoinDate = document.getElementById('detail-join-date');

      if (detailSistem) detailSistem.textContent = data.sistemKemitraan || 'Tidak tersedia';
      if (detailPaket) detailPaket.textContent = data.paketUsaha || 'Tidak tersedia';
      if (detailSales) detailSales.textContent = data.sales || 'Tidak tersedia';

      // Payment/Pelunasan badge
      if (detailPaymentBadge) {
         // Parse numeric values for comparison (same logic as isUserPaidOff)
         const parseNumber = (v: any) => {
            if (v === null || typeof v === 'undefined') return null;
            if (typeof v === 'number') return v;
            if (typeof v === 'string') {
               const cleaned = v.replace(/[^0-9.,-]/g, '');
               if (cleaned === '') return null;
               const commaCount = (cleaned.match(/,/g) || []).length;
               const dotCount = (cleaned.match(/\./g) || []).length;
               let normalized = cleaned;
               if (commaCount > 0 && dotCount > 0 && cleaned.indexOf(',') > cleaned.indexOf('.')) {
                  normalized = cleaned.replace(/\./g, '').replace(/,/g, '.');
               } else if (commaCount > 0 && dotCount === 0) {
                  normalized = cleaned.replace(/,/g, '.');
               }
               const n = parseFloat(normalized);
               return isNaN(n) ? null : n;
            }
            return null;
         };

         const rawKekurangan = data.kekurangan ?? data.sisa ?? data.sisaPembayaran ?? data.sisa_pelunasan ?? null;
         const kekuranganNum = parseNumber(rawKekurangan);
         const isKekuranganZero = kekuranganNum !== null && kekuranganNum <= 0;

         const totalPaid = parseNumber(data.totalPaid ?? data.paidAmount ?? data.total_pembayaran ?? data.jumlahPembayaran ?? data.pembayaranTotal ?? null);
         const packagePrice = parseNumber(data.hargaPaket ?? data.nilaiPaketUsaha ?? data.totalPrice ?? data.totalHarga ?? data.harga ?? null);
         const paidByComparison = (totalPaid !== null && packagePrice !== null && totalPaid >= packagePrice);

         const pelunasanStatuses: string[] = [];
         try {
            if (Array.isArray(data?.pelunasan)) {
               data.pelunasan.forEach((p: any) => {
                  if (p && typeof p.status === 'string') pelunasanStatuses.push(p.status.toLowerCase());
                  if (p && typeof p.isPaid !== 'undefined' && p.isPaid === true) pelunasanStatuses.push('paid');
               });
            } else if (data?.pelunasan && typeof data.pelunasan === 'object' && data.pelunasan.status) {
               pelunasanStatuses.push(String(data.pelunasan.status).toLowerCase());
            }
            if (data?.statusPelunasan) pelunasanStatuses.push(String(data.statusPelunasan).toLowerCase());
            if (data?.pelunasanStatus) pelunasanStatuses.push(String(data.pelunasanStatus).toLowerCase());
            if (data?.paymentStatus) pelunasanStatuses.push(String(data.paymentStatus).toLowerCase());
         } catch (e) { /* ignore */ }

         const isPelunasanApproved = (
            data?.pelunasanApproved === true ||
            pelunasanStatuses.includes('approved') ||
            pelunasanStatuses.includes('lunas') ||
            pelunasanStatuses.includes('paid')
         );

         const isPaidOff = (
            data?.nilaiPaketUsaha === 'Full Payment' ||
            data?.isFullPayment === true ||
            data?.isPaidOff === true ||
            isPelunasanApproved ||
            isKekuranganZero ||
            paidByComparison
         );

         let badgeClass = 'bg-yellow-100 text-yellow-800';
         let badgeText = 'Belum Lunas';
         let badgeIcon = '';
         
         if (isPaidOff) {
            badgeClass = 'bg-green-100 text-green-800';
            badgeText = 'Lunas';
            badgeIcon = '';
         }

         detailPaymentBadge.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeClass}`;
         detailPaymentBadge.textContent = `${badgeIcon} ${badgeText}`;
      }

      // Join date - try multiple possible field names
      if (detailJoinDate) {
         // Try different possible field names for join date
         const joinDateValue = data.joinDate || data.createdAt || data.tanggalBergabung || data.join_date || data.created_at;

         if (joinDateValue) {
            try {
               const date = new Date(joinDateValue);
               // Check if date is valid
               if (!isNaN(date.getTime())) {
                  detailJoinDate.textContent = date.toLocaleDateString('id-ID', {
                     year: 'numeric',
                     month: 'long',
                     day: 'numeric'
                  });
               } else {
                  detailJoinDate.textContent = 'Format tanggal tidak valid';
                  console.warn('[DEBUG] Invalid join date format:', joinDateValue);
               }
            } catch (error) {
               detailJoinDate.textContent = 'Error parsing tanggal';
               console.error('[DEBUG] Error parsing join date:', error, joinDateValue);
            }
         } else {
            // Fallback: use current date as join date if no date field is available
            const currentDate = new Date();
            detailJoinDate.textContent = currentDate.toLocaleDateString('id-ID', {
               year: 'numeric',
               month: 'long',
               day: 'numeric'
            });
         }
      } else {
         console.warn('[DEBUG] detail-join-date element not found');
      }
   }

   function updateActivityInfo(data: any) {
      // Last login - handle multiple possible field names and show real-time info
      const lastLogin = document.getElementById('last-login');
      if (lastLogin) {
         const lastLoginTime = data.lastLogin || data.lastLoginAt || data.last_login || data.updatedAt;
         
         if (lastLoginTime) {
            const date = new Date(lastLoginTime);
            const now = new Date();
            const diffInHours = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60));
            
            let displayText;
            if (diffInHours < 1) {
               displayText = 'Baru saja';
            } else if (diffInHours < 24) {
               displayText = `${diffInHours} jam yang lalu`;
            } else if (diffInHours < 168) { // 7 days
               const diffInDays = Math.floor(diffInHours / 24);
               displayText = `${diffInDays} hari yang lalu`;
            } else {
               displayText = date.toLocaleDateString('id-ID', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
               });
            }
            lastLogin.textContent = displayText;
         } else {
            lastLogin.textContent = 'Belum pernah login';
         }
      }

      // Account created - handle multiple field names with better formatting
      const accountCreated = document.getElementById('account-created');
      if (accountCreated) {
         const createdTime = data.createdAt || data.created_at || data.tanggalDaftar || data.joinDate || data.registeredAt;
         
         if (createdTime) {
            const date = new Date(createdTime);
            const now = new Date();
            const diffInDays = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24));
            
            let displayText;
            if (diffInDays === 0) {
               displayText = 'Hari ini';
            } else if (diffInDays === 1) {
               displayText = 'Kemarin';
            } else if (diffInDays < 30) {
               displayText = `${diffInDays} hari yang lalu`;
            } else if (diffInDays < 365) {
               const diffInMonths = Math.floor(diffInDays / 30);
               displayText = `${diffInMonths} bulan yang lalu`;
            } else {
               displayText = date.toLocaleDateString('id-ID', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric'
               });
            }
            accountCreated.textContent = displayText;
         } else {
            accountCreated.textContent = 'Tidak diketahui';
         }
      }

      // Account status - enhanced with multiple status checks and visual indicators
      const accountStatus = document.getElementById('account-status');
      if (accountStatus) {
         const statusIndicator = accountStatus.previousElementSibling?.querySelector('div');
         
         // Check multiple possible status fields
         const isActive = data.isActive !== false && 
                          data.status !== 'inactive' && 
                          data.status !== 'suspended' && 
                          data.statusAkun !== 'tidak_aktif' && 
                          data.accountStatus !== 'inactive';
         
         const isPending = data.status === 'pending' || data.statusAkun === 'menunggu_persetujuan';
         const isSuspended = data.status === 'suspended' || data.statusAkun === 'suspend';
         
         let statusText;
         let statusColor = 'bg-amber-500'; // default
         
         if (isSuspended) {
            statusText = 'Ditangguhkan';
            statusColor = 'bg-red-500';
         } else if (isPending) {
            statusText = 'Menunggu Persetujuan';
            statusColor = 'bg-yellow-500';
         } else if (isActive) {
            statusText = 'Aktif';
            statusColor = 'bg-green-500';
         } else {
            statusText = 'Tidak Aktif';
            statusColor = 'bg-gray-500';
         }
         
         accountStatus.textContent = statusText;
         
         // Update status indicator color
         if (statusIndicator) {
            statusIndicator.className = `w-2 h-2 sm:w-3 sm:h-3 ${statusColor} rounded-full shadow-sm`;
         }
      }
   }

   // Financial Section Functions - Google Sheets Integration
   function initializeFinancialSection() {
      loadUserSheetsUrl();
      setupSheetsEventListeners();
      loadFinancialDataFromSheets();
      setInterval(loadFinancialDataFromSheets, 5 * 60 * 1000);
   }

   async function saveUserSheetsUrl(url: string) {
      try {
         const token = localStorage.getItem('mitraToken');
         updateConnectionStatus('connecting', 'Menyimpan link...');
         
         const response = await fetch(`${API_URL}/api/mitra/sheets-url`, {
            method: 'POST',
            headers: {
               'Authorization': `Bearer ${token}`,
               'Content-Type': 'application/json'
            },
            body: JSON.stringify({ sheetsUrl: url })
         });

         const result = await response.json();
         
         if (response.ok && result.success) {
            showNotification('Link Google Sheets berhasil disimpan!', 'success');
            updateConnectionStatus('syncing', 'Sinkronisasi data...');
            // Enable open button
            const openBtn = document.getElementById('open-sheets-btn') as HTMLButtonElement;
            if (openBtn) openBtn.disabled = false;
            
            // Load data and update status when done
            await loadFinancialDataFromSheets();
            updateConnectionStatus('connected', 'Tersambung ke Google Sheets');
         } else {
            throw new Error(result.error || 'Gagal menyimpan link');
         }

      } catch (error) {
         console.error('Error saving sheets URL:', error);
         updateConnectionStatus('error', 'Gagal menyimpan');
         showNotification('Gagal menyimpan link Google Sheets', 'error');
      }
   }

   async function loadUserSheetsUrl() {
      try {
         const token = localStorage.getItem('mitraToken');
         const response = await fetch(`${API_URL}/api/mitra/sheets-url`, {
            method: 'GET',
            headers: {
               'Authorization': `Bearer ${token}`,
               'Content-Type': 'application/json'
            }
         });

         const result = await response.json();
         
         if (response.ok && result.success) {
            const sheetsInput = document.getElementById('sheets-url-input') as HTMLInputElement;
            const openBtn = document.getElementById('open-sheets-btn') as HTMLButtonElement;
            if (sheetsInput) {
               sheetsInput.value = result.data.sheetsUrl || '';
            }
            
            // Update connection status based on whether URL exists
            if (result.data.sheetsUrl && result.data.sheetsUrl.length > 0) {
               if (openBtn) openBtn.disabled = false;
               updateConnectionStatus('connected', 'Tersambung ke Google Sheets');
            } else {
               if (openBtn) openBtn.disabled = true;
               updateConnectionStatus('none', 'Belum tersambung');
            }
         } else {
            await createUserGoogleSheets();
         }

      } catch (error) {
         console.error('Error loading sheets URL:', error);
         updateConnectionStatus('error', 'Gagal memuat koneksi');
         
         // Use demo/template URL for development
         const sheetsInput = document.getElementById('sheets-url-input') as HTMLInputElement;
         const openBtn = document.getElementById('open-sheets-btn') as HTMLButtonElement;
         if (sheetsInput) {
            sheetsInput.value = '';
         }
         if (openBtn) openBtn.disabled = true;
      }
   }

   async function createUserGoogleSheets() {
      try {
         const token = localStorage.getItem('mitraToken');
         updateConnectionStatus('connecting', 'Membuat Google Sheets...');
         
         const response = await fetch(`${API_URL}/api/mitra/create-sheets`, {
            method: 'POST',
            headers: {
               'Authorization': `Bearer ${token}`,
               'Content-Type': 'application/json'
            }
         });

         const result = await response.json();
         
         if (response.ok && result.success) {
            const sheetsInput = document.getElementById('sheets-url-input') as HTMLInputElement;
            const openBtn = document.getElementById('open-sheets-btn') as HTMLButtonElement;
            if (sheetsInput) {
               sheetsInput.value = result.data.sheetsUrl;
            }
            if (openBtn) openBtn.disabled = false;
            updateConnectionStatus('connected', 'Tersambung - Sheets baru dibuat');
            showNotification('Google Sheets baru telah dibuat untuk Anda!', 'success');
         } else {
            throw new Error(result.error || 'Gagal membuat Google Sheets');
         }

      } catch (error) {
         console.error('Error creating Google Sheets:', error);
         updateConnectionStatus('error', 'Gagal membuat koneksi');
         showNotification('Gagal membuat Google Sheets. Coba lagi nanti.', 'error');
      }
   }

   function setupSheetsEventListeners() {
      // Save & Sync button
      const saveBtn = document.getElementById('save-sheets-url');
      if (saveBtn) {
         saveBtn.addEventListener('click', async function() {
            const input = document.getElementById('sheets-url-input') as HTMLInputElement;
            const url = input?.value?.trim();
            
            if (!url) {
               showNotification('Masukkan link Google Sheets terlebih dahulu!', 'error');
               return;
            }
            
            if (!url.includes('docs.google.com/spreadsheets')) {
               showNotification('Link harus berupa Google Sheets yang valid!', 'error');
               return;
            }
            
            await saveUserSheetsUrl(url);
         });
      }
      
      // Sync Now button
      const syncBtn = document.getElementById('sync-now-btn');
      if (syncBtn) {
         syncBtn.addEventListener('click', function() {
            loadFinancialDataFromSheets();
         });
      }
      
      // Open Sheets button
      const openBtn = document.getElementById('open-sheets-btn');
      if (openBtn) {
         openBtn.addEventListener('click', function() {
            const input = document.getElementById('sheets-url-input') as HTMLInputElement;
            const url = input?.value?.trim();
            if (url) {
               window.open(url, '_blank');
            }
         });
      }
   }

   async function loadFinancialDataFromSheets() {
      try {
         const token = localStorage.getItem('mitraToken');
         updateConnectionStatus('syncing', 'Sinkronisasi data...');
         
         const response = await fetch(`${API_URL}/api/mitra/sheets-data`, {
            method: 'GET',
            headers: {
               'Authorization': `Bearer ${token}`,
               'Content-Type': 'application/json'
            }
         });

         const result = await response.json();
         
         if (response.ok && result.success) {
            const data = result.data;
            
            if (data.today) {
               updateTodayFinancialDisplay(data.today);
            }
            
            if (data.monthly) {
               updateMonthlyFinancialDisplay(data.monthly);
            }
            
            if (data.weekly) {
               updateWeeklyFinancialDisplay(data.weekly);
            }
            
            if (data.history) {
               updateFinancialHistory(data.history);
            }
            
            updateConnectionStatus('connected', 'Data tersinkron');
            updateLastSyncTime();
            
         } else {
            throw new Error(result.error || 'Gagal memuat data dari Sheets');
         }

      } catch (error) {
         console.error('Error loading sheets data:', error);
         updateConnectionStatus('error', 'Gagal sync data');
         
         // Use mock data for development
         useMockFinancialData();
      }
   }

   function updateConnectionStatus(status: 'connecting' | 'connected' | 'syncing' | 'error' | 'none', message: string) {
      const indicator = document.getElementById('connection-status-indicator');
      const textElement = document.getElementById('connection-status-text');
      
      if (!indicator || !textElement) return;
      
      // Reset classes
      indicator.className = 'w-2.5 h-2.5 rounded-full flex-shrink-0';
      textElement.className = 'text-sm font-medium';
      
      // Set appropriate status color and message
      switch (status) {
         case 'connected':
            indicator.classList.add('bg-green-500');
            textElement.classList.add('text-green-700');
            textElement.textContent = message;
            
            // Enable open button
            const openBtn = document.getElementById('open-sheets-btn') as HTMLButtonElement;
            if (openBtn) {
               openBtn.disabled = false;
            }
            break;
            
         case 'syncing':
         case 'connecting':
            indicator.classList.add('bg-blue-500', 'animate-pulse');
            textElement.classList.add('text-blue-700');
            textElement.textContent = message;
            break;
            
         case 'error':
            indicator.classList.add('bg-red-500');
            textElement.classList.add('text-red-700');
            textElement.textContent = message;
            break;
            
         default:
            indicator.classList.add('bg-gray-400');
            textElement.classList.add('text-gray-700');
            textElement.textContent = message;
            break;
      }
   }

   function updateLastSyncTime() {
      const timeElement = document.getElementById('last-sync-time');
      if (timeElement) {
         const now = new Date();
         timeElement.textContent = `Terakhir sync: ${now.toLocaleTimeString('id-ID')}`;
      }
   }

   // Update display functions (now receives data from Google Sheets)
   function updateTodayFinancialDisplay(data: any) {
      const omsetElement = document.getElementById('omset-hari-ini');
      const belanjaElement = document.getElementById('belanja-hari-ini');
      const omsetTimeElement = document.getElementById('omset-update-time');
      const belanjaTimeElement = document.getElementById('belanja-update-time');

      if (omsetElement) {
         omsetElement.textContent = formatRupiah(data.omset || 0);
      }
      
      if (belanjaElement) {
         belanjaElement.textContent = formatRupiah(data.belanja || 0);
      }

      if (omsetTimeElement) {
         omsetTimeElement.textContent = 'Dari Google Sheets';
      }
      
      if (belanjaTimeElement) {
         belanjaTimeElement.textContent = 'Dari Google Sheets';
      }
   }

   function updateMonthlyFinancialDisplay(data: any) {
      const omsetBulananElement = document.getElementById('omset-bulanan');
      const periodeElement = document.getElementById('omset-bulanan-periode');

      if (omsetBulananElement) {
         omsetBulananElement.textContent = formatRupiah(data.totalOmset || 0);
      }

      // Tampilkan hanya 'Dari Google Sheets' untuk periode
      if (periodeElement) {
         periodeElement.textContent = 'Dari Google Sheets';
      }
   }

   function updateWeeklyFinancialDisplay(data: any) {
      const avgOmsetElement = document.getElementById('avg-omset-7days');
      const avgBelanjaElement = document.getElementById('avg-belanja-7days');
      const avgProfitElement = document.getElementById('avg-profit-7days');

      if (avgOmsetElement) {
         avgOmsetElement.textContent = formatRupiah(data.avgOmset || 0);
      }

      if (avgBelanjaElement) {
         avgBelanjaElement.textContent = formatRupiah(data.avgBelanja || 0);
      }

      if (avgProfitElement) {
         const profit = (data.avgOmset || 0) - (data.avgBelanja || 0);
         avgProfitElement.textContent = formatRupiah(profit);
         avgProfitElement.className = `font-semibold ${profit >= 0 ? 'text-green-600' : 'text-red-600'}`;
      }
   }

   function updateFinancialHistory(data: any[]) {
      const historyElement = document.getElementById('recent-history');
      if (!historyElement) return;

      if (!data || data.length === 0) {
         historyElement.innerHTML = `
            <div class="text-center text-gray-500 py-8">
               Menunggu data dari Google Sheets...
            </div>
         `;
         return;
      }

      historyElement.innerHTML = data.map(item => {
         const date = new Date(item.date).toLocaleDateString('id-ID', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric' 
         });
         const profit = (item.omset || 0) - (item.belanja || 0);
         const profitColor = profit >= 0 ? 'text-green-600' : 'text-red-600';

         return `
            <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
               <div>
                  <p class="font-medium text-sm">${date}</p>
                  <p class="text-xs text-gray-500">Omset: ${formatRupiah(item.omset || 0)}</p>
               </div>
               <div class="text-right">
                  <p class="text-xs text-gray-500">Belanja: ${formatRupiah(item.belanja || 0)}</p>
                  <p class="font-semibold text-sm ${profitColor}">Profit: ${formatRupiah(profit)}</p>
               </div>
            </div>
         `;
      }).join('');
   }

   function useMockFinancialData() {
      
      updateTodayFinancialDisplay({
         omset: 0,
         belanja: 0
      });

      updateMonthlyFinancialDisplay({
         totalOmset: 0,
         totalDays: 0
      });

      updateWeeklyFinancialDisplay({
         avgOmset: 0,
         avgBelanja: 0
      });

      const mockHistory = [
         { date: '2025-08-24', omset: 0, belanja: 0 },
         { date: '2025-08-23', omset: 0, belanja: 0 },
         { date: '2025-08-22', omset: 0, belanja: 0 },
         { date: '2025-08-21', omset: 0, belanja: 0 },
         { date: '2025-08-20', omset: 0, belanja: 0 }
      ];

      updateFinancialHistory(mockHistory);
      
      updateConnectionStatus('connected', 'Mode Development');
      updateLastSyncTime();
   }

   function formatRupiah(amount: number): string {
      return new Intl.NumberFormat('id-ID', {
         style: 'currency',
         currency: 'IDR',
         minimumFractionDigits: 0,
         maximumFractionDigits: 0
      }).format(amount);
   }

   // Expose functions to global scope for navbar integration
   (window as any).updateDashboardMargin = updateDashboardMargin;
   (window as any).initializeDashboardMargin = initializeDashboardMargin;
</script>
</Layout>